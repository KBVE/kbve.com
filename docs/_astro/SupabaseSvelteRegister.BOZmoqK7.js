import{a as ut,M as ht,N as T,I as gt,O as pt,l as ft,b as mt,i as wt,t as O,P as yt,Q as B,J as Le,K as Fe,R as q,d as G,f as V,j as h,g as bt,k as S,S as Ue,n as vt,F as I,D as $,E as A,r as b,q as k,T as kt,U as Oe,V as Pt,v as X,w as v,W as Ct,X as Y,A as Q}from"./svelte.BEh2_tzM.js";import{p as Re,a as xt}from"./@nanostores.fwZirWO6.js";import{t as $t,m as Nt,a as ze}from"./nanostores.Bo9-_MAV.js";import{c as Dt}from"./@supabase.BOUp28WM.js";import{D as fe}from"./dexie.C6WUSPtX.js";import{R as St,r as he,j as Z}from"./react.BO4Kayu4.js";import{a as x}from"./axios.Bw-gCGc_.js";import{E as L}from"./three.xRXBQ6Zu.js";import"./esm-env.rsSWfq8L.js";import"./@react-three.4bQWeJYP.js";import"./react-use-measure.yU5S79rD.js";import"./its-fine.B0m_k8NB.js";import"./react-reconciler.D42_nvds.js";import"./react-dom.Cq2Wkcjl.js";import"./@babel.CF3RwP-h.js";import"./three-stdlib.DSm8ebGF.js";import"./zustand.yH8b0vWy.js";import"./use-sync-external-store.ClVNGCf-.js";import"./Page.astro_astro_type_script_index_0_lang.DXQ60Fh7.js";var We=(c=>(c.DARK="dark",c.LIGHT="light",c))(We||{});const Je={hcaptcha:"5ba581fa-b6fc-4bb0-8222-02fcd6a59e35",hcaptcha_api:"https://js.hcaptcha.com/1/api.js",api:"https://supabase.kbve.com",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ewogICJyb2xlIjogImFub24iLAogICJpc3MiOiAic3VwYWJhc2UiLAogICJpYXQiOiAxNzI0NTM2ODAwLAogICJleHAiOiAxODgyMzAzMjAwCn0._fmEmblm0afeLoPXxt8wP2mYpa9gzU-ufx3v8oRTFGg"},K={_state:{...Je},get(){return{...this._state}},set(c){this._state={...this._state,...c}},reset(){this._state={...Je}},toString(){return JSON.stringify(this._state,null,2)},getKey(c){return this._state[c]}},U="0123456789ABCDEFGHJKMNPQRSTVWXYZ";function It(c,e,t){for(;c.length<e;)c=t+c;return c}function _t(){const c=Math.floor(Math.random()*U.length);return U.charAt(c)}function Et(c){let e="";for(let t=0;t<c;t++)e+=_t();return e}function Mt(c,e){let t="";for(let a=e-1;a>=0;a--){const s=c%U.length;t=U.charAt(s)+t,c=Math.floor(c/U.length)}return It(t,e,U[0])}function je(){const c=Date.now(),e=Mt(c,10),t=Et(16),a=e+t;return{toString:()=>a,valueOf:()=>a}}const Tt={id:"",title:"",description:"",journals:[],isComplete:!1,reward:""},At={backpack:[],equipment:{head:null,body:null,legs:null,feet:null,hands:null,weapon:null,shield:null,accessory:null}},He={},Lt={inCombat:!1,isDead:!1,isResting:!1,activeBoosts:{}},Ft={username:"Guest",health:"100",mana:"100",energy:"100",maxHealth:"100",maxMana:"100",maxEnergy:"100",armour:"0",agility:"0",strength:"0",intelligence:"0",experience:"0",reputation:"0",faith:"0"},Ut={stats:Ft,inventory:At,state:Lt},Ot={tooltipItem:{id:null,position:{x:0,y:0}},submenuItem:{id:null,position:{x:0,y:0}},tooltipNPC:{id:null,position:{x:0,y:0}},isStatsMenuCollapsed:!1,isSettingsMenuCollapsed:!1,debugMode:!1,textSpeed:40},Jt={gamemode:"Idle",action:{type:"ROLL_DICE",diceValues:[],isRolling:!1},textures:{side1:"",side2:"",side3:"",side4:"",side5:"",side6:""}};function E(c,e){return Re(c,e,{encode(t){return JSON.stringify(t)},decode(t){try{return JSON.parse(t)}catch{return e}}})}E("playerData",Ut);E("quest",Tt);E("items",He);E("notifications",[]);E("itemDB",He);const ge=E("settings",Ot);E("minigameState",Jt);const jt=c=>ge.get()[c],qe=(c,e)=>{$t(async()=>{const t=ge.get();ge.set({...t,[c]:e})})},Bt=()=>{qe("debugMode",!0)},Rt=()=>{qe("debugMode",!1)},te=()=>jt("debugMode"),ee=c=>typeof c=="string"?c:JSON.stringify(c,null,2),zt=c=>{te()&&console.log(`[DEBUG] ${ee(c)}`)},Wt=c=>{te()&&console.warn(`[DEBUG] ${ee(c)}`)},Ht=(c,e)=>{te()&&(e instanceof Error?console.error(`[DEBUG] ${ee(c)} - Error: ${e.message}
${e.stack}`):console.error(`[DEBUG] ${ee(c)}`))},o={enable:Bt,disable:Rt,isEnabled:te,log:zt,warn:Wt,error:Ht};class qt{constructor(){this.events={},this.lastEmitted=new Map}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e]?.push(t)}off(e,t){this.events[e]&&(this.events[e]=this.events[e]?.filter(a=>a!==t))}emit(e,t,a=0,s){const r=Date.now(),i=this.lastEmitted.get(e)||0;if(r-i>=a){if(!this.events[e])return;this.events[e]?.forEach(n=>n(t)),s&&o.isEnabled()&&o.log(`Event: ${String(e)} - Message: ${s}`),o.isEnabled()&&o.log(`Event Data: ${String(e)} - Data: ${t?JSON.stringify(t):"No data"}`),this.lastEmitted.set(e,r)}}}const _=new qt,pe={id:"",email:"",updatedAt:new Date,fullName:"Guest",username:"Guest"},F=Nt(pe),Be=ze(!1),R=ze(null);class Ge extends fe{constructor(){super("KilobaseDB"),this.supabase=null,this.profileKey="userProfile",this.handleUserRedirect=e=>{if(!e||!e.location)return;const{location:t,timer:a=0,replace:s=!1}=e;console.log(`Redirecting user to: ${t} in ${a}ms`),setTimeout(()=>{this.cleanupEventListeners(),s?window.location.replace(t):window.location.href=t},a)},this.version(1).stores({keyValueStore:"key",profiles:"&id, email",errorLogs:"++id, actionId, message, timestamp",actionULID:"&id, action, timestamp, status, errorId"}),this.profiles=this.table("profiles"),this.errorLogs=this.table("errorLogs"),this.actionULID=this.table("actionULID"),this.supabase=this.initializeSupabaseClient(),this.initializeEventListeners()}initializeEventListeners(){_.on("redirectUser",this.handleUserRedirect)}cleanupEventListeners(){_.off("redirectUser",this.handleUserRedirect)}initializeSupabaseClient(){if(typeof window<"u"&&window.supabase&&(console.log("Using global Supabase client instance:",window.supabase),this.supabase=window.supabase),!this.supabase)try{this.supabase=Dt(K.get().api,K.get().anonKey),console.log("Supabase client instance created:",this.supabase),typeof window<"u"&&(window.supabase=this.supabase)}catch(e){throw console.error("Error creating Supabase client:",e),e}return this.supabase}getSupabaseClient(){return this.supabase}async registerUser(e,t,a,s,r,i){const n=this.getSupabaseClient();if(!n)return null;try{if(t!==a)return await this.handleAuthError({message:"Password and confirm password do not match."},s),null;const{data:l,error:d}=await n.auth.signUp({email:e,password:t,options:{captchaToken:i,data:{username:r,full_name:r}}});if(d)return await this.handleAuthError(d,s),null;if(l?.user){const f={id:l.user.id,email:l.user.email||"",username:l.user.user_metadata?.username||void 0,fullName:l.user.user_metadata?.full_name||void 0,updatedAt:new Date(l.user.updated_at||Date.now())};return await this.saveProfile(f),await this.updateActionStatus(s,"completed"),f}}catch(l){return await this.handleAuthError(l,s),null}return null}async createActionULID(e){const t=je().toString(),a={id:t,action:e,timestamp:new Date,status:"pending"};return await this.actionULID.add(a),t}async handleAuthError(e,t){let a="An unknown error occurred. Please try again.",s={...e},r="";e?.message&&(a=e.message),e?.code&&(r+=`Error Code: ${e.code}. `),e?.status&&(r+=`Status: ${e.status}. `),e?.supabaseCode&&(r+=`Supabase Code: ${e.supabaseCode}. `),e?.details&&(r+=`Details: ${JSON.stringify(e.details)}. `),r&&(a=`${a} (${r.trim()})`);const i={invalid_grant:"Invalid credentials provided.",invalid_request:"The request is missing a required parameter.",expired_token:"The token has expired. Please log in again.",invalid_token:"The token provided is invalid. Please try again.",email_already_exists:"The email address is already in use.",user_already_exists:"A user with this identifier already exists. Please log in instead.",invalid_password:"The password provided is incorrect."};switch(e?.code&&i[e.code]&&(a=i[e.code]),e?.status){case 400:a="Bad request. Please check the input fields.";break;case 401:a="Unauthorized. Please check your credentials.";break;case 403:a="Forbidden. You do not have permission to perform this action.";break;case 404:a="Resource not found. Please try again.";break;case 422:a="Unprocessable entity. Please check the provided data.";break;case 500:a="Internal server error. Please try again later.";break;default:a=a||"An unknown error occurred. Please try again.";break}throw await this.logError(a,{...s,supabaseCode:e?.code,statusCode:e?.status},t),console.error("Authentication Error:",a),new Error(a)}async saveProfile(e){try{await this.table("keyValueStore").put({key:this.profileKey,value:e}),e.username&&R.set(e.username),F.set(e),console.log("Profile saved locally:",e)}catch(t){console.error("Failed to save profile locally:",t)}}async loadProfile(){try{const e=await this.table("keyValueStore").get(this.profileKey);if(e?.value){F.set(e.value),console.log("Profile loaded from local storage:",e.value);return}await this.loadProfileFromSupabase()}catch(e){console.error("Failed to load profile:",e)}}async loadProfileFromSupabase(){const e=this.getSupabaseClient();if(e)try{Be.set(!0);const{data:{user:t},error:a}=await e.auth.getUser();if(a){console.error("Failed to get authenticated user from Supabase:",a),await this.logError("Failed to get authenticated user from Supabase",a);return}if(!t){console.warn("No authenticated user found");return}const{data:s,error:r}=await e.from("user_profiles").select("id, username, updated_at").eq("id",t.id).single();if(r){console.error("Failed to load user profile from Supabase:",r),await this.logError("Failed to load user profile from Supabase",r);return}if(s){const i={id:s.id,email:t.email||"",username:s.username||void 0,fullName:t.user_metadata?.full_name||void 0,updatedAt:new Date(s.updated_at)};await this.saveProfile(i),console.log("Profile loaded and saved from Supabase:",i)}}catch(t){console.error("An unexpected error occurred while loading the profile:",t),await this.logError("An unexpected error occurred while loading the profile",t)}finally{Be.set(!1)}}async removeProfile(){const e=this.getSupabaseClient();if(e)try{const t=F.get();await this.table("keyValueStore").delete(this.profileKey),await this.profiles.delete(t.id),F.set(pe),console.log(`Profile ${t.id} removed locally and store reset`),R.set(null);const{error:a}=await e.auth.signOut();a?(await this.logError("Failed to log out user from Supabase",a),console.error("Failed to log out user from Supabase:",a)):console.log("User logged out successfully from Supabase.")}catch(t){await this.logError("Failed to remove profile",t),console.error("Failed to remove profile:",t)}}async getProfile(){const e=F.get();if(e.id!=="")return e;try{const t=await this.table("keyValueStore").get(this.profileKey);if(t?.value){const a=t.value;return F.set(a),a}}catch(t){console.error("Failed to get profile from Dexie:",t)}return pe}async createAction(e){const a={id:je().toString(),action:e,timestamp:new Date,status:"pending"};return await this.actionULID.add(a),a}async updateActionStatus(e,t,a){await this.actionULID.update(e,{status:t,errorId:a})}async logError(e,t,a){try{let s=null;if(a&&(s=await this.errorLogs.where("actionId").equals(a).first()),s){console.warn(`Error already exists for actionId: ${a}. Skipping new error log.`);return}const r={message:e,details:t,actionId:a,timestamp:new Date},i=await this.errorLogs.add(r);console.log("Error logged to Dexie:",r),a&&await this.updateActionStatus(a,"failed",i)}catch(s){console.error("Failed to log error:",s)}}async extractAuthErrorDetails(e){if(!e)return"Unknown error occurred. No error details available.";let t=e.message||"Unknown error occurred",a="";return e?.code&&(a+=`Error Code: ${e.code}. `),e?.status&&(a+=`Status: ${e.status}. `),e?.supabaseCode&&(a+=`Supabase Code: ${e.supabaseCode}. `),e?.details&&(a+=`Details: ${JSON.stringify(e.details)}. `),a&&(t=`${t} (${a.trim()})`),t}async getDetailedErrorByActionId(e){try{const t=await this.errorLogs.where("actionId").equals(e).last();return t?this.extractAuthErrorDetails(t):null}catch(t){return console.error(`Failed to retrieve detailed error for actionId: ${e}`,t),null}}async getErrorByActionId(e){try{const t=await this.errorLogs.where("actionId").equals(e).last();return t?t.message:null}catch(t){return console.error(`Failed to retrieve error for actionId: ${e}`,t),null}}async loginUser(e,t,a,s){const r=this.getSupabaseClient();if(!r)return null;try{const{data:i,error:n}=await r.auth.signInWithPassword({email:e,password:t,options:{captchaToken:s}});if(n)return await this.handleAuthError(n,a),null;if(i?.user){const l={id:i.user.id,email:i.user.email||"",username:i.user.user_metadata?.username||void 0,fullName:i.user.user_metadata?.full_name||void 0,updatedAt:new Date(i.user.updated_at||Date.now())};return await this.saveProfile(l),console.log("User logged in successfully:",l),l}}catch(i){return await this.handleAuthError(i,a),null}return null}async getSession(){const e=this.getSupabaseClient();if(!e)return null;try{const{data:t,error:a}=await e.auth.getSession();return a?(console.error("Failed to retrieve session:",a),null):t.session||null}catch(t){return console.error("Error getting session:",t),null}}async getUsername(){if(R.get())return R.get();try{const e=await this.table("keyValueStore").get(this.profileKey);if(e?.value?.username)return R.set(e.value.username),e.value.username}catch(e){console.error("Failed to get username from Dexie:",e)}return null}static createPersistentAtom(e,t){return Re(e,t,{encode:JSON.stringify,decode:JSON.parse})}createPersistentMap(e,t){return xt(e,t,{encode:JSON.stringify,decode:JSON.parse})}updateAtomField(e,t,a){e.set({...e.get(),[t]:a})}updateMapField(e,t,a){const r={...e.get(),[t]:a};e.set(r)}removeMapField(e,t){const a=e.get(),{[t]:s,...r}=a;e.set(r)}removeAtomField(e,t){const a=e.get(),{[t]:s,...r}=a;e.set(r)}resetState(e,t){e.set(t)}getPersistentAtom(e){return e.get()}}Ge.createPersistentAtom("atlas",{plugin:[]});const z=new Ge;function Gt(c){const{elementIdOrName:e,duration:t=500,onComplete:a}=c;let s=null;if(s=document.getElementById(e),!s){const r=document.getElementsByName(e);r.length>0&&(s=r[0])}if(!s){o.error(`Loader element with ID or name "${e}" not found.`);return}if(!(s instanceof HTMLElement)){o.error(`Element found by "${e}" is not an HTMLElement.`);return}o.log(`Removing loader element with ID or name "${e}" with duration ${t}ms.`),s.classList.add("opacity-0","transition-opacity",`duration-${t}`),setTimeout(()=>{s&&(s.style.display="none"),o.log(`Loader element with ID or name "${e}" has been hidden.`),a&&a()},t)}class Vt extends fe{constructor(){super("MapDatabase"),this.chunkSize=10,this.tileWidth=32,this.tileHeight=32,this.chunkWidth=this.chunkSize*this.tileWidth,this.chunkHeight=this.chunkSize*this.tileHeight,this.scale=1,this.displayedChunks=new Set,this.version(1).stores({maps:"tilemapKey",jsonFiles:"tilemapKey",tilesetImages:"tilemapKey",chunks:"[tilemapKey+chunkX+chunkY]",tileJsonData:"tilemapKey"}),this.maps=this.table("maps"),this.jsonFiles=this.table("jsonFiles"),this.tilesetImages=this.table("tilesetImages"),this.chunks=this.table("chunks"),this.tileJsonData=this.table("tileJsonData")}resetMapSettings(){this.displayedChunks.clear()}async initializeMapDatabase(){const e="/api/mapdb.json",t="https://kbve.com/api/mapdb.json";let a;try{a=(await x.get(e)).data,o.log(`Map database loaded from ${e}`)}catch{o.warn(`Failed to load map database from ${e}, trying fallback URL.`);try{a=(await x.get(t)).data,o.log(`Map database loaded from ${t}`)}catch{o.error(`Failed to load map database from both ${e} and ${t}`);return}}if(a&&a.key){for(const s in a.key)if(Object.prototype.hasOwnProperty.call(a.key,s)){const r=a.key[s];await this.addMap(r),await this.addJsonData(s,r.jsonDataUrl);const i=await this.fetchTilesetImage(r.tilesetImageUrl);i&&await this.addTilesetImage(s,i)}o.log("Map database initialized and data loaded.")}else o.error("Invalid map database format.")}async addMap(e){await this.maps.put(e)}async getMap(e){return await this.maps.get(e)}async addJsonData(e,t){await this.jsonFiles.put({tilemapKey:e,jsonData:t})}async getJsonData(e){return(await this.jsonFiles.get(e))?.jsonData}async addTilesetImage(e,t){await this.tilesetImages.put({tilemapKey:e,imageData:t})}async getTilesetImage(e){return(await this.tilesetImages.get(e))?.imageData}async getBounds(e){return(await this.maps.get(e))?.bounds}async getNpcsFromTilesetKey(e){const t=await Xt.getMap(e);if(!t){o.error(`No map data found for tilesetKey: ${e}`);return}return t.npcs}async fetchMapData(e){try{return(await x.get(e)).data}catch(t){o.error(`Failed to fetch map data from ${e}:`,t);return}}async fetchJsonData(e){try{return(await x.get(e)).data}catch(t){o.error(`Failed to fetch JSON data from ${e}:`,t);return}}async fetchTilesetImage(e){try{return(await x.get(e,{responseType:"blob"})).data}catch(t){o.error(`Failed to fetch tileset image from ${e}:`,t);return}}async initializeMap(e,t,a,s){try{const r=await this.fetchMapData(t);if(r){await this.addMap(r);const i=await this.fetchJsonData(a);i&&await this.addJsonData(e,i);const n=await this.fetchTilesetImage(s);n&&await this.addTilesetImage(e,n)}}catch(r){o.error("Failed to initialize map database:",r)}}async loadMapIntoScene(e,t){const a=await this.getMap(t);if(!a){o.error(`Map with key ${t} not found`);return}const s=await this.getJsonData(t);if(!s){o.error(`JSON data for map ${t} not found`);return}const r=await this.getTilesetImage(t);if(!r){o.error(`Tileset image for map ${t} not found`);return}let i=null;try{i=URL.createObjectURL(r)}catch(n){o.error(`Failed to create object URL for tileset image: ${n}`);return}if(!i){o.error(`Tileset image URL for map ${t} could not be created.`);return}e.load.tilemapTiledJSON(t,s),e.load.image(a.tilesetKey,i),e.load.once("complete",()=>{const n=e.make.tilemap({key:t}),l=n.addTilesetImage(a.tilesetName,a.tilesetKey);if(l)for(let d=0;d<n.layers.length;d++){const f=n.createLayer(d,l,0,0);f?f.scale=a.scale:o.error(`Layer ${d} could not be created.`)}else o.error(`Tileset ${a.tilesetName} could not be created.`)}),e.load.start()}async loadMap(e,t){const a=await this.getMap(t);if(!a)throw new Error(`Map with key ${t} not found`);const s=await this.getJsonData(t);if(!s)throw new Error(`JSON data for map ${t} not found`);const r=await this.getTilesetImage(t);if(!r)throw new Error(`Tileset image for map ${t} not found`);let i=null;try{i=URL.createObjectURL(r)}catch(n){throw new Error(`Failed to create object URL for tileset image: ${n}`)}if(!i)throw new Error(`Tileset image URL for map ${t} could not be created.`);return e.load.tilemapTiledJSON(t,s),e.load.image(a.tilesetKey,i),new Promise(n=>{e.load.once("complete",()=>{const l=e.make.tilemap({key:t});if(l.addTilesetImage(a.tilesetName,a.tilesetKey)){for(let f=0;f<l.layers.length;f++){const g=l.createLayer(f,a.tilesetName,0,0);g?g.scale=a.scale:console.error(`Layer ${f} could not be created.`)}n(l)}else console.error(`Tileset ${a.tilesetName} could not be created.`),n(null)}),e.load.start()})}async prepareMapLoad(e){if(!await this.getMap(e))throw new Error(`Map with key ${e} not found`);if(!await this.getJsonData(e))throw new Error(`JSON data for map ${e} not found`);const s=await this.getTilesetImage(e);if(!s)throw new Error(`Tileset image for map ${e} not found`);let r=null;try{r=URL.createObjectURL(s)}catch(i){throw new Error(`Failed to create object URL for tileset image: ${i}`)}if(!r)throw new Error(`Tileset image URL for map ${e} could not be created.`);await this.chunkMap(e)}async getParsedJsonData(e){const t=await this.tileJsonData.get(e);if(t)return t.jsonContent;const a=await this.jsonFiles.get(e);if(!a)return o.error(`JSON file path for ${e} not found`),null;try{const r=(await x.get(a.jsonData)).data;return await this.tileJsonData.put({tilemapKey:e,jsonContent:r}),r}catch(s){return o.error(`Failed to fetch or parse JSON data for ${e}:`,s),null}}async addChunk(e,t,a,s,r){o.log(`Adding chunk for (${t}, ${a}) of ${e}`),o.log(`Chunk data: ${s}`),await this.chunks.put({tilemapKey:e,chunkX:t,chunkY:a,jsonData:s,imageData:r})}async getChunk(e,t,a){const s=await this.chunks.get([e,t,a]);return o.log(`Retrieved chunk for (${t}, ${a}) of ${e}: ${s}`),s}async removeChunk(e,t,a){await this.chunks.delete([e,t,a])}async removeChunks(e,t){const a=t.map(({chunkX:s,chunkY:r})=>this.removeChunk(e,s,r));await Promise.all(a)}async extractChunkJsonData(e,t,a,s){const r=await this.getParsedJsonData(e);if(!r)return o.error(`Parsed JSON data for map ${e} not found`),null;const i=t*s,n=a*s,l=Math.min(i+s,r.width),d=Math.min(n+s,r.height),f=[];for(let g=n;g<d;g++){const y=r.layers[0].data.slice(g*r.width+i,g*r.width+l);f.push(...y)}return{...r,width:l-i,height:d-n,layers:[{...r.layers[0],data:f}]}}async getMapDimensions(e){const t=await this.getParsedJsonData(e);if(!t){o.error(`Failed to retrieve JSON data for ${e}`);return}const a=t.width,s=t.height;if(a>0&&s>0)return{width:a,height:s};o.error(`Invalid JSON data for map ${e}`)}async chunkMap(e){const t=await this.getMapDimensions(e);if(!t){o.error(`Failed to retrieve dimensions for map ${e}`);return}const{width:a,height:s}=t,r=10,i=Math.ceil(a/r),n=Math.ceil(s/r);o.log(`Starting chunkMap for ${e}`);for(let l=0;l<i;l++)for(let d=0;d<n;d++){const f=await this.extractChunkJsonData(e,l,d,r);if(!f){o.error(`Failed to extract JSON data for chunk (${l}, ${d}) of ${e}`);continue}o.log(`Storing chunk (${l}, ${d}) for ${e}`),await this.addChunk(e,l,d,f)}o.log(`Finished chunkMap for ${e}`)}async loadChunkIntoScene(e,t,a,s){const r=await this.getChunk(t,a,s);if(!r){o.error(`Chunk data for (${a}, ${s}) not found`);return}const i=`${t}_${a}_${s}`;if(!await this.getMap(t)){o.error(`Map data not found for ${t}`);return}const l=r.jsonData.tilesets[0].name;if(!e.textures.exists(l)){const g=await this.getTilesetImage(t);if(g){const y=URL.createObjectURL(g);e.load.image(l,y),await new Promise(m=>e.load.once("complete",m)),e.load.start()}else{o.error(`Failed to load tileset image for ${l}`);return}}e.load.tilemapTiledJSON(i,r.jsonData),await new Promise(g=>e.load.once("complete",g)),e.load.start();const d=e.make.tilemap({key:i}),f=d.addTilesetImage(l);f?d.layers.forEach((g,y)=>{const m=d.createLayer(y,f,0,0);m?(m.setScale(this.scale),o.log(`Layer ${y} created for chunk (${a}, ${s}) with tileset ${l}.`)):o.error(`Layer ${y} could not be created for chunk (${a}, ${s}).`)}):o.error(`Tileset ${l} could not be added to tilemap.`)}removeChunkFromScene(e,t,a,s){const r=`${t}_${a}_${s}`,i=e.make.tilemap({key:r});i&&i.destroy(),e.cache.tilemap.remove(r)}async updateVisibleChunks(e,t,a,s,r){if(!await this.getMap(t)){console.error(`Map data for ${t} not found`);return}const n=this.tileWidth,l=this.tileHeight,d=this.chunkSize,f=Math.floor(a/(d*n)),g=Math.floor(s/(d*l)),y=new Set;for(let m=-r;m<=r;m++)for(let P=-r;P<=r;P++){const N=f+m,J=g+P,ae=`${N},${J}`;N>=0&&J>=0&&(await this.loadChunkIntoScene(e,t,N,J),y.add(ae))}for(const m of this.displayedChunks)if(!y.has(m)){const[P,N]=m.split(",").map(Number);this.removeChunkFromScene(e,t,P,N)}this.displayedChunks=y}async loadNewMap(e,t,a,s){o.log(`Loading map with key: ${t}`),this.resetMapSettings();const r=await this.getMap(t);if(!r)return o.error(`Map data not found for ${t}`),null;const i=Math.floor(a/(this.chunkWidth||1)),n=Math.floor(s/(this.chunkHeight||1)),l=await this.getChunk(t,i,n);if(!l)return o.error(`Chunk (${i}, ${n}) not found for ${t}`),null;const d=r.tilesetKey;if(!e.textures.exists(d)){const m=await this.getTilesetImage(t);if(m){const P=URL.createObjectURL(m);e.load.image(d,P),await new Promise(N=>{e.load.once("complete",N),e.load.start()})}else return o.error(`Failed to load tileset image for ${d}`),null}const f=`${t}_${i}_${n}`;e.load.tilemapTiledJSON(f,l.jsonData),await new Promise(m=>e.load.once("complete",m)),e.load.start();const g=e.make.tilemap({key:f});if(!g)return o.error(`Tilemap could not be created for chunk (${i}, ${n})`),null;const y=g.addTilesetImage(r.tilesetName,d);if(!y)return o.error(`Tileset ${d} could not be added to tilemap.`),null;for(let m=0;m<g.layers.length;m++){const P=g.createLayer(m,y,0,0);P?(P.setScale(r.scale||this.scale),o.log(`Layer ${m} created for initial chunk.`)):o.error(`Layer ${m} could not be created.`)}return g}}const Xt=new Vt;new L(-Math.PI/2,-Math.PI/2,-Math.PI/2),new L(0,Math.PI/2,0),new L(0,-Math.PI/2,-Math.PI/2),new L(Math.PI/2,Math.PI,Math.PI),new L(0,0,-Math.PI/2),new L(Math.PI,0,0);const Yt=({text:c,speed:e=80,onComplete:t})=>{const[a,s]=he.useState([]),r=he.useRef([]);return he.useEffect(()=>{let i,n=0;const l=c.split(/(<\/?span[^>]*>)/g).filter(Boolean),d=[];l.forEach((g,y)=>{if(g.startsWith("<span")||g.startsWith("</span")){const m=g.match(/<span class="([^"]*)">/);if(m){const P=m[1];d.push(Z.jsx("span",{className:P},`span-${y}`))}else d.push(Z.jsx("span",{},`span-${y}`))}else g.split("").forEach((m,P)=>{d.push(Z.jsx("span",{children:m},`char-${y}-${P}`))})}),n=0;const f=()=>{n<d.length?(r.current=[...r.current,d[n]],s([...r.current]),n++,i=window.setTimeout(f,e)):t&&t()};return r.current=[],s([]),f(),()=>{window.clearTimeout(i)}},[c,e,t]),Z.jsx("div",{children:a})};St.memo(Yt);class Qt extends fe{constructor(){super("NPCDatabase"),this.version(3).stores({npcs:"id,name",sprites:"id",avatars:"id",dialogues:"id"}),this.npcs=this.table("npcs"),this.sprites=this.table("sprites"),this.avatars=this.table("avatars"),this.dialogues=this.table("dialogues")}async addNPC(e){await this.npcs.put(e)}async getNPC(e){return await this.npcs.get(e)}async getNPCByName(e){return await this.npcs.where("name").equals(e).first()}async getAllNPCs(){return await this.npcs.toArray()}async exportNPCs(){const e=await this.getAllNPCs();return JSON.stringify(e,null,2)}async importNPCs(e){const t=JSON.parse(e);await this.npcs.bulkPut(t)}async fetchNPCData(e){try{return(await x.get(e)).data}catch(t){o.error(`Failed to fetch NPC data from ${e}:`,t);return}}async addSprite(e){await this.sprites.put(e)}async getSprite(e){return await this.sprites.get(e)}async getAllSprites(){return await this.sprites.toArray()}async addAvatar(e){await this.avatars.put(e)}async getAvatar(e){return await this.avatars.get(e)}async getAllAvatars(){return await this.avatars.toArray()}async urlToBlob(e){try{return(await x.get(e,{responseType:"blob"})).data}catch(t){o.error(`Failed to fetch blob from ${e}:`,t);return}}async addNewSprite(e,t){const a=await this.urlToBlob(e);if(a){const s={...t,spriteData:a};return await this.addSprite(s),s.id}}async addNewNPC(e,t,a){const s={...e,spriteImageId:t,avatarImageId:a};await this.addNPC(s)}async addNewAvatar(e,t){const a=await this.urlToBlob(e);if(a){const s={...t,avatarData:a};return await this.addAvatar(s),s.id}}async fetchAvatars(e){try{const a=(await x.get(e)).data.key;for(const s in a){const r=a[s];let i=await this.urlToBlob(r.avatarLocation);if(i||(i=await this.urlToBlob(`https://kbve.com${r.avatarLocation}`)),i){const n={id:r.id,avatarName:r.avatarName,avatarLocation:r.avatarLocation,avatarData:i,slug:r.slug};await this.addAvatar(n)}}}catch(t){o.error(`Failed to fetch avatars from ${e}:`,t)}}async fetchSprites(e){try{const a=(await x.get(e)).data.key;for(const s in a){const r=a[s];let i=await this.urlToBlob(r.assetLocation);if(i||(i=await this.urlToBlob(`https://kbve.com${r.assetLocation}`)),i){const n={id:r.id,spriteName:r.spriteName,assetLocation:r.assetLocation,frameWidth:r.frameWidth,frameHeight:r.frameHeight,scale:r.scale,slug:r.slug,spriteData:i};await this.addSprite(n)}}}catch(t){o.error(`Failed to fetch sprites from ${e}:`,t)}}async fetchNPCs(e){try{const a=(await x.get(e)).data.key;for(const s in a){const r=a[s],i={id:r.id,name:r.name,spriteKey:r.spriteKey,walkingAnimationMapping:r.walkingAnimationMapping,startPosition:r.startPosition,speed:r.speed,scale:r.scale,slug:r.slug,actions:r.actions,effects:r.effects,stats:r.stats,spriteImageId:r.spriteImageId,avatarImageId:r.avatarImageId,dialogues:r.dialogues||[]};await this.addNPC(i)}}catch(t){o.error(`Failed to fetch NPCs from ${e}:`,t)}}async initializeDatabase(e="https://kbve.com"){await this.fetchAvatars(`${e}/api/avatardb.json`),await this.fetchSprites(`${e}/api/spritedb.json`),await this.fetchNPCs(`${e}/api/npcdb.json`),await this.fetchDialogues(`${e}/api/dialogue.json`)}async loadNPC(e,t,a,s){try{o.log(`Loading NPC with name: ${t}`);const r=await this.getNPCByName(t);if(!r)throw new Error(`NPC with name ${t} not found`);o.log(`NPC Data: ${JSON.stringify(r)}`),await this.loadCharacter(e,r.id,a,s)}catch(r){r instanceof Error?o.error(`Failed to load NPC: ${r.message}`):o.error("Failed to load NPC:",r)}}async loadCharacter(e,t,a,s){try{o.log(`Loading NPC with ID: ${t}`);const r=await this.getNPC(t);if(!r)throw new Error(`NPC with ID ${t} not found`);o.log(`NPC Data: ${JSON.stringify(r)}`);const i=r.spriteKey;if(e.textures.exists(i))o.log(`Texture with key ${i} already loaded.`),this.addNPCToScene(e,r,a,s);else{o.log(`Texture with key ${i} not found, attempting to load.`);const n=await this.getSprite(r.spriteImageId);if(n&&n.spriteData){o.log(`Sprite Data: ${JSON.stringify(n)}`);const l=URL.createObjectURL(n.spriteData);e.load.spritesheet(i,l,{frameWidth:n.frameWidth,frameHeight:n.frameHeight}),e.load.once("complete",()=>{o.log(`Texture ${i} loaded successfully.`),this.addNPCToScene(e,r,a,s)}),e.load.start()}else throw new Error(`Sprite with ID ${r.spriteImageId} not found`)}}catch(r){r instanceof Error?o.error(`Failed to load NPC: ${r.message}`):o.error("Failed to load NPC:",r)}}addNPCToScene(e,t,a,s){try{o.log(`Adding NPC to scene: ${JSON.stringify(t)}`),o.log(`Using sprite key: ${t.spriteKey}`);const r=e.add.sprite(0,0,t.spriteKey);r.scale=t.scale||1.5,r.name=t.id||"Error Missing Name",o.log(`NPC Sprite created with texture key ${t.spriteKey} at position (${t.startPosition.x}, ${t.startPosition.y})`);const i={id:t.id,sprite:r,walkingAnimationMapping:t.walkingAnimationMapping,startPosition:{x:a??t.startPosition.x,y:s??t.startPosition.y},speed:t.speed};if(o.log(`Grid engine config: ${JSON.stringify(i)}`),!e.textures.exists(t.spriteKey))throw new Error(`Texture with key ${t.spriteKey} does not exist in the scene`);e.gridEngine.addCharacter(i),o.log(`NPC added to grid engine with ID ${t.id}`),((l,d,f)=>{const g=e.gridEngine.getPosition(l.name);o.log(`Attaching NPC events to ${d} at position: ${JSON.stringify(g)}`),ea.attachNPCEvent(l,d,f,{coords:g})})(r,t.name,t.actions.map(l=>({label:l}))),o.log(`NPC ${t.name} added to scene successfully`)}catch(r){r instanceof Error?o.error(`Error adding NPC to scene from addNPCToScene: ${r.message}`):o.error("Error adding NPC to scene:",r)}}async addDialogue(e){await this.dialogues.put(e)}async getDialogue(e){return await this.dialogues.get(e)}async getAllDialogues(){return await this.dialogues.toArray()}async getDialoguesForNPC(e){const t=await this.getNPC(e);if(!t)throw new Error(`NPC with ID ${e} not found`);return(await Promise.all((t.dialogues||[]).map(s=>this.getDialogue(s.dialogueId)))).filter(s=>s!==void 0)}async markDialogueAsRead(e,t){const a=await this.getNPC(e);if(!a)throw new Error(`NPC with ID ${e} not found`);const s=a.dialogues?.find(r=>r.dialogueId===t);s&&(s.read=!0,await this.addNPC(a))}async fetchDialogues(e){try{const a=(await x.get(e)).data.key,s=Object.values(a).map(r=>({...r}));await this.dialogues.bulkPut(s)}catch(t){o.error(`Failed to fetch dialogues from ${e}:`,t)}}async getPrioritizedDialoguesForNPC(e){try{const t=await this.getNPC(e);if(!t)throw new Error(`NPC with ID ${e} not found`);const s=(await Promise.all((t.dialogues||[]).map(async r=>{const i=await this.getDialogue(r.dialogueId);return i?{...i,priority:r.priority,read:r.read}:null}))).filter(r=>r!==null);return s.sort((r,i)=>i.priority-r.priority),s}catch(t){return o.error(`Failed to get prioritized dialogues for NPC with ID ${e}:`,t),[]}}async getNPCNameById(e){return(await this.getNPC(e))?.name}async getNPCAvatarById(e){const t=await this.getNPC(e);if(t?.avatarImageId)return(await this.getAvatar(t.avatarImageId))?.avatarData}async getNPCSlugById(e){return(await this.getNPC(e))?.slug}async getNPCHealthById(e){try{return(await this.getNPC(e))?.stats?.health}catch(t){o.error(`Failed to get health for NPC with ID ${e}:`,t);return}}async getNPCManaById(e){try{return(await this.getNPC(e))?.stats?.mana}catch(t){o.error(`Failed to get mana for NPC with ID ${e}:`,t);return}}async createNPCSession(e,t){try{const a=this.getNPCNameById(t),s=this.getNPCSlugById(t),r=this.getNPCAvatarById(t),i=this.getNPCHealthById(t),n=this.getNPCManaById(t),[l,d,f,g,y]=await Promise.all([a,s,r,i,n]),m={...e.get(),[`${t}_name`]:l||"Unknown",[`${t}_slug`]:d||"Unknown",[`${t}_avatar`]:f?URL.createObjectURL(f):"Unknown",[`${t}_health`]:g||"100",[`${t}_mana`]:y||"100"};e.set(m)}catch{const s={...e.get(),[`${t}_name`]:"Unknown",[`${t}_slug`]:"Unknown",[`${t}_avatar`]:"Unknown",[`${t}_hp`]:"100",[`${t}_mana`]:"100"};e.set(s)}}async getNPCDialogueOptionsByULID(e){try{const t=await this.getDialogue(e);if(!t||!t.options)return"[]";const a=await Promise.all(t.options.map(async s=>this.getDialogue(s)));return JSON.stringify(a.filter(s=>s!==void 0))}catch(t){return o.error(`Failed to get dialogue options for ID ${e}:`,t),"[]"}}async getAllDialogueOptions(e){const t=[],a=new Set,s=async r=>{if(a.has(r))return;a.add(r);const i=await this.getDialogue(r);if(i&&(t.push(i),i.options&&i.options.length>0))for(const n of i.options)await s(n)};return await s(e),t}async createDialogueSession(e,t){try{const a=await this.getNPCDialogueOptionsByULID(t),s={...e.get(),[`${t}_options`]:a||"[]"};e.set(s)}catch{const s={...e.get(),[`${t}_options`]:"[]"};e.set(s)}}}const Zt=new Qt;class Kt{constructor(){this.actionHandlers={talk:this.talkToNPC.bind(this),quest:this.questWithNPC.bind(this),trade:this.tradeWithNPC.bind(this),combat:this.startCombat.bind(this),heal:this.healNPC.bind(this),steal:this.stealFromNPC.bind(this),lore:this.loreFromNPC.bind(this)}}getActionHandler(e){return this.actionHandlers[e]}loreFromNPC(e){o.log(`Pulling up the lore of the NPC with ID: ${e.npcId}`)}questWithNPC(e){o.log(`Starting quest with NPC with ID: ${e.npcId}`)}healNPC(e){o.log(`Healing NPC with ID: ${e.npcId}`)}oathFromNPC(e){o.log(`Oath from NPC with ID: ${e.npcId}`)}async talkToNPC(e){try{o.log(`Talking to NPC with ID: ${e.npcId}`);const t=await Zt.getPrioritizedDialoguesForNPC(e.npcId);if(o.log(t),t.length>0){const a=t[0];_.emit("npcDialogue",{npcId:e.npcId,dialogue:a},1e3)}else o.log("No dialogues available for this NPC.")}catch(t){o.error(`Failed to fetch dialogues for NPC with ID ${e.npcId}:`,t)}}tradeWithNPC(e){o.log(`Trading with NPC with ID: ${e.npcId}`)}moveToNPC(e){const a=e.data?.coords||{x:10,y:15};_.emit("playerMove",a)}stealFromNPC(e){o.log(`Attempting to steal from NPC with ID: ${e.npcId}`);const t={npcId:e.npcId,npcName:e.npcName,data:e.data};_.emit("playerSteal",t)}startCombat(e){o.log(`Starting combat with NPC with ID: ${e.npcId}`)}checkFish(e){o.log(`Checking fish for NPC with ID: ${e.npcId}`)}attachNPCEvent(e,t,a,s){e.setInteractive(),e.on("pointerover",r=>{const i={npcId:e.name||"",npcName:t,actions:a.map(n=>n.label),data:s||{},coords:{x:r.x,y:r.y}};_.emit("npcInteraction",i),e.setTint(65280)}),e.on("pointerout",()=>{e.clearTint()}),e.on("pointerdown",r=>{const i={npcId:e.name||"",npcName:t,actions:a.map(n=>n.label),data:s||{},coords:{x:r.x,y:r.y}};o.log(`Click Registered at X: ${i.coords.x} Y: ${i.coords.y}`),_.emit("npcInteractionClick",i,1e3)})}}const ea=new Kt;var ta=Pt("<script async defer><\/script><!---->",1),aa=O('<div class="max-w-xs bg-white border border-gray-200 rounded-xl shadow-lg dark:bg-neutral-800 dark:border-neutral-700 z-100" role="alert" tabindex="-1" aria-labelledby="hs-toast-normal-example-label"><div class="flex p-4"><div class="shrink-0"><svg class="shrink-0 size-4 text-blue-500 mt-0.5" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"></path></svg></div> <div class="ms-3"><p id="hs-toast-normal-example-label" class="text-sm text-gray-700 dark:text-neutral-400">Processing...</p></div></div></div>'),ra=O('<div class="max-w-xs bg-white border border-gray-200 rounded-xl shadow-lg dark:bg-neutral-800 dark:border-neutral-700 z-100" role="alert" tabindex="-1" aria-labelledby="hs-toast-error-example-label"><div class="flex p-4"><div class="shrink-0"><svg class="shrink-0 size-4 text-red-500 mt-0.5" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"></path></svg></div> <div class="ms-3"><p id="hs-toast-error-example-label" class="text-sm text-gray-700 dark:text-neutral-400"> </p></div></div></div>'),sa=O('<div class="flex"><span class="text-lg text-cyan-600 dark:text-cyan-300"> </span></div>'),ia=O('<div class="inline-flex items-center"><span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span> <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span> <div class="px-2 text-gray-600 dark:text-neutral-400 text-wrap w-1/2"> </div></div>'),oa=O('<div class="inline-flex items-center"><span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span> <span class="relative inline-flex rounded-full h-3 w-3 bg-cyan-500"></span></span> <span class="px-2 text-gray-600 dark:text-neutral-400 font-bold">Online</span></div>'),na=O('<div><div class="py-16 opacity-0 transition-opacity duration-500" id="formulation_form"><div class="px-16 flex flex-row justify-center items-center lg:justify-between"><div class="relative"><h3 class="text-blue-400 mb-1">Sign up</h3> <h1 class="page-title text-white font-bold text-3xl mb-5 lg:text-3xl xl:text-4xl 2xl:text-5xl">KBVE Authentication Portal</h1> <!> <!> <!> <form id="registerForm" class="opacity-0 transition-opacity duration-500" action="#"><div class="grid gap-y-2 md:gap-y-4"><div><label for="login-username" class="mb-1 block text-xs text-left md:text-sm md:mb-2 text-neutral-800 dark:text-neutral-200">Username</label> <div><input type="text" id="register-username" name="username" autocomplete="username" class="block w-full h-4 md:h-12 rounded-lg border border-neutral-200 bg-neutral-50 px-4 py-3 text-sm text-neutral-700 focus:border-neutral-200 focus:outline-none focus:ring focus:ring-neutral-400 disabled:pointer-events-none disabled:opacity-50 dark:border-neutral-600 dark:bg-neutral-700/30 dark:text-neutral-300 dark:focus:ring-1" required aria-describedby="register-username"></div></div> <div><label for="register-email" class="mb-1 block text-xs text-left md:text-sm md:mb-2 text-neutral-800 dark:text-neutral-200">Email Address</label> <div><input type="email" id="register-email" name="email" autocomplete="email" class="block w-full h-4 md:h-12 rounded-lg border border-neutral-200 bg-neutral-50 px-4 py-3 text-sm text-neutral-700 focus:border-neutral-200 focus:outline-none focus:ring focus:ring-neutral-400 disabled:pointer-events-none disabled:opacity-50 dark:border-neutral-600 dark:bg-neutral-700/30 dark:text-neutral-300 dark:focus:ring-1" required aria-describedby="register-email"></div></div> <div><div class="flex items-center justify-between"><label for="register-password" class="mb-1 block text-xs md:text-sm md:mb-2 text-neutral-800 dark:text-neutral-200">Password</label></div> <div><input type="password" id="register-password" name="password" class="block w-full h-4 md:h-12 rounded-lg border border-neutral-200 bg-neutral-50 px-4 py-3 text-sm text-neutral-700 focus:border-neutral-200 focus:outline-none focus:ring focus:ring-neutral-400 disabled:pointer-events-none disabled:opacity-50 dark:border-neutral-600 dark:bg-neutral-700/30 dark:text-neutral-300 dark:focus:ring-1" required aria-describedby="register-password"></div></div> <div><div class="flex items-center justify-between"><label for="confirm-register-password" class="mb-1 block text-xs md:text-sm md:mb-2 text-neutral-800 dark:text-neutral-200">Confirm Password</label></div> <div><input type="password" id="confirm-register-password" name="password" class="block w-full h-4 md:h-12 rounded-lg border border-neutral-200 bg-neutral-50 px-4 py-3 text-sm text-neutral-700 focus:border-neutral-200 focus:outline-none focus:ring focus:ring-neutral-400 disabled:pointer-events-none disabled:opacity-50 dark:border-neutral-600 dark:bg-neutral-700/30 dark:text-neutral-300 dark:focus:ring-1" required aria-describedby="confirm-register-password"></div></div> <div><div class="flex justify-center scale-75 md:scale-100"></div></div> <button type="submit"> </button></div></form></div> <div class="flex flex-col w-1/2"><div><!></div> <dotlottie-player></dotlottie-player></div></div></div></div>',2);function Da(c,e){ut(e,!1);const t=ht(),a=()=>{I(d,!1),$(p,h(p).successful_message=""),h(n)&&h(l)&&h(g)&&hcaptcha.reset(h(g))},s=u=>{if(h(n)&&h(l)&&h(g))return hcaptcha.execute(h(g),u)};async function r(){if(I(d,!0),y=await z.createActionULID("registerUser"),!y){$(p,h(p).svelte_internal_message="Failed to create action!"),a();return}try{const u=await z.registerUser(h(p).email,h(p).password,h(p).confirm,y,h(p).username,h(p).captchaToken);if(u){$(p,h(p).successful_message=`Welcome, ${u.username||u.email}! Registration successful. Redirecting in 2 Seconds`),console.log("User registered and profile saved:",u);const w=await z.getSession();w?(console.log("User is already logged in after registration:",w),setTimeout(()=>{window.location.href="/dashboard"},1500)):setTimeout(()=>{window.location.href="/login"},1500);return}await i(y)}catch(u){console.error("Registration failed:",u),await i(y)}finally{I(d,!1)}}async function i(u){const w=await z.getErrorByActionId(u);w?$(p,h(p).svelte_internal_message=w):$(p,h(p).svelte_internal_message="An unexpected error occurred. Please try again.");const C=await z.getDetailedErrorByActionId(u);C?I(m,C):$(p,h(p).svelte_internal_message="An unexpected error occurred. Please try again.")}let n=A(!1),l=A(!1),d=A(!1),f="/robot.lottie",g=A(),y,m=A(),P=T(e,"hl",8,""),N=T(e,"sitekey",24,()=>K.get().hcaptcha),J=T(e,"apihost",24,()=>K.get().hcaptcha_api),ae=T(e,"reCaptchaCompat",8,!0),me=T(e,"theme",24,()=>We.DARK),we=T(e,"size",8,"compact"),p=A({email:"",password:"",confirm:"",username:"",captchaToken:"",svelte_internal_message:"",successful_message:""});const Ve=new URLSearchParams({recaptchacompat:ae()?"on":"off",onload:"hcaptchaOnLoad",render:"explicit"}),Xe=`${J()}?${Ve.toString()}`,ye=Math.floor(Math.random()*100),Ye="inline-flex w-full items-center justify-center gap-x-2 rounded-lg px-4 py-1 text-sm font-normal text-blue-400 focus-visible:ring outline-none transition duration-300 py-3",Qe="border border-transparent",Ze="bg-blue-100 dark:focus:outline-none",Ke="hover:bg-blue-400 hover:text-white",et="2xl:text-base",tt="disabled:pointer-events-none disabled:opacity-50 disabled:animate-pulse",at="ring-zinc-500 dark:ring-zinc-200";gt(()=>{Gt({elementIdOrName:"skeleton_login_loader",duration:500}),document.getElementById("astro_error_message")&&document.getElementById("astro_error_message");const u=document.getElementById("formulation_form");u&&setTimeout(()=>{u.classList.replace("opacity-0","opacity-100")},200);const w=document.getElementById("registerForm");w&&setTimeout(()=>{w.classList.replace("opacity-0","opacity-100")},500),window.hcaptchaOnLoad=()=>{t("load"),I(l,!0)},window.onSuccess=C=>{t("success",{token:C}),$(p,h(p).captchaToken=C)},window.onError=()=>{t("error")},window.onClose=()=>{t("close")},window.onExpired=()=>{t("expired"),a()},t("mount"),I(n,!0)}),pt(()=>{window.hcaptchaOnLoad=null,window.onSuccess=null,h(l)&&(hcaptcha=null)}),ft(()=>(h(n),h(l),Y(N()),Y(P()),Y(me()),Y(we())),()=>{h(n)&&h(l)&&I(g,hcaptcha.render(`h-captcha-${ye}`,{sitekey:N(),hl:P(),theme:me(),callback:"onSuccess","error-callback":"onError","close-callback":"onClose","expired-callback":"onExpired",size:we()}))}),mt(),wt();var re=na();yt(u=>{var w=kt(),C=Oe(w);{var D=M=>{var H=ta(),Ae=Oe(H);Le(Ae,"src",Xe),k(Ae),S(M,H)};B(C,M=>{h(n)&&!window?.hcaptcha&&M(D)})}S(u,w)});var be=b(re),ve=b(be),se=b(ve),ke=k(b(se),4);{var rt=u=>{var w=aa();S(u,w)};B(ke,u=>{h(d)&&u(rt)})}var Pe=k(ke,2);{var st=u=>{var w=ra(),C=b(w),D=k(b(C),2),M=b(D),H=b(M,!0);v(M),v(D),v(C),v(w),G(()=>Q(H,h(p).svelte_internal_message)),S(u,w)};B(Pe,u=>{h(p).svelte_internal_message&&u(st)})}var Ce=k(Pe,2);{var it=u=>{var w=sa(),C=b(w),D=b(C,!0);v(C),v(w),G(()=>Q(D,h(p).successful_message)),S(u,w)};B(Ce,u=>{h(p).successful_message&&u(it)})}var ie=k(Ce,2),xe=b(ie),oe=b(xe),$e=k(b(oe),2),Ne=b($e);X(Ne),v($e),v(oe);var ne=k(oe,2),De=k(b(ne),2),Se=b(De);X(Se),v(De),v(ne);var le=k(ne,2),Ie=k(b(le),2),_e=b(Ie);X(_e),v(Ie),v(le);var ce=k(le,2),Ee=k(b(ce),2),Me=b(Ee);X(Me),v(Ee),v(ce);var de=k(ce,2),ot=b(de);Le(ot,"id",`h-captcha-${ye??""}`),v(de);var W=k(de,2);Fe(W,1,`${Ye} ${Qe} ${Ze} ${Ke} ${et} ${tt} ${at}`);var nt=b(W,!0);v(W),v(xe),v(ie),v(se);var Te=k(se,2),ue=b(Te),lt=b(ue);{var ct=u=>{var w=ia(),C=k(b(w),2),D=b(C,!0);v(C),v(w),G(()=>Q(D,h(m))),S(u,w)},dt=u=>{var w=oa();S(u,w)};B(lt,u=>{h(m)?u(ct):u(dt,!1)})}v(ue);var j=k(ue,2);return q(j,"autoplay",!0),q(j,"loop",!0),Fe(j,1,"hidden md:block md:w-full"),q(j,"mode","normal"),q(j,"src",`/assets/lottie/${f}`),v(Te),v(ve),v(be),v(re),G(()=>{W.disabled=h(d),Q(nt,h(d)?"Loading...":"Register")}),V(Ne,()=>h(p).username,u=>$(p,h(p).username=u)),V(Se,()=>h(p).email,u=>$(p,h(p).email=u)),V(_e,()=>h(p).password,u=>$(p,h(p).password=u)),V(Me,()=>h(p).confirm,u=>$(p,h(p).confirm=u)),bt("submit",ie,Ct(r)),S(c,re),Ue(e,"reset",a),Ue(e,"execute",s),vt({reset:a,execute:s})}export{Da as default};
