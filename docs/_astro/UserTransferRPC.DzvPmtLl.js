import{r as m,j as e}from"./react.CvslfkeK.js";import{u as O}from"./react-hook-form.D5LhBzNo.js";import{t as B}from"./@hookform.DFFlZybA.js";import{z as s}from"./zod.D6aOmuMC.js";import{s as D}from"./supabaseClient.BT68OKvR.js";import{u as v}from"./@nanostores.J-Z5GVtw.js";import{b as P,u as $}from"./userstate.ClT1tpkg.js";import{t as l}from"./tailwind-merge.B9ugUrge.js";import"./@react-three.B-wTPXHf.js";import"./@supabase.d6fxE5ud.js";import"./Page.astro_astro_type_script_index_0_lang.Db7LHE3J.js";import"./react-dom.CtWA3ti2.js";import"./svelte.BEh2_tzM.js";import"./esm-env.rsSWfq8L.js";import"./nanostores.Bo9-_MAV.js";const _=s.object({to_user:s.string().uuid(),kind:s.enum(["credit","khash"]),amount:s.number().positive().max(1e6),reason:s.string().min(3,{message:"Reason must be at least 3 characters."}).max(100,{message:"Reason must be at most 100 characters."}).regex(/^[a-zA-Z0-9 _\-()]+$/,{message:"Reason can only contain letters, numbers, spaces, underscores, hyphens, and parentheses."}),meta:s.record(s.any()).optional()});async function V(d){const c=_.safeParse(d);if(!c.success)return{error:c.error,data:null};const{to_user:i,kind:r,amount:f,reason:n,meta:u}=c.data,{data:o,error:h}=await D.rpc("transfer_balance_proxy",{p_to_user:i,p_kind:r,p_amount:f,p_reason:n,p_meta:u??{}});return{data:o,error:h}}const se=()=>{v($);const d=v(P),[c,i]=m.useState(!1),[r,f]=m.useState(null),[n,u]=m.useState(""),[o,h]=m.useState(null),{register:x,handleSubmit:C,watch:R,formState:{errors:t,isSubmitting:z,isValid:S},reset:F}=O({resolver:B(_),mode:"onChange",defaultValues:{kind:"credit"}}),b=R(),{hasEnough:E,fee:T,total:A,balanceError:k}=m.useMemo(()=>{const a=b.kind||"credit",p=Number(b.amount)||0,U=a==="credit"?d?.credits||0:d?.khash||0,j=p*.01+20,g=p+j,N=p>0&&U>=g;let w="";return p>0&&!N&&(w=`Insufficient ${a} balance. You need at least ${g.toFixed(2)} (amount + fee).`),{hasEnough:N,fee:j,total:g,balanceError:w}},[b.amount,b.kind,d]),y=!S||!E||z,I=a=>{f(a),i(!0)},M=async()=>{if(r&&n==="CONFIRM"){const a=await V(r);h(a),i(!1),u(""),F()}};return e.jsxs("div",{className:"max-w-md mx-auto p-6 rounded-2xl shadow-xl bg-gradient-to-br from-cyan-50/80 to-purple-50/60 dark:from-cyan-900/40 dark:to-purple-900/30 border border-cyan-200 dark:border-zinc-800 backdrop-blur-md bg-white/60 dark:bg-zinc-900/60",children:[e.jsx("h3",{className:"text-2xl font-bold mb-4 text-cyan-700 dark:text-cyan-200 drop-shadow",children:"Transfer Balance"}),e.jsxs("form",{onSubmit:C(I),className:"flex flex-col gap-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-neutral-700 dark:text-neutral-200 mb-1",children:"Recipient User UUID"}),e.jsx("input",{...x("to_user"),placeholder:"Recipient User UUID",className:l("input input-bordered w-full bg-white/80 dark:bg-zinc-800/70 text-neutral-900 dark:text-neutral-100 border-cyan-300 dark:border-cyan-700 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 placeholder:text-neutral-400 dark:placeholder:text-neutral-500 px-4 py-2",t.to_user&&"border-red-400 focus:border-red-500")}),t.to_user&&e.jsx("span",{className:"text-red-500 text-xs mt-1 block",children:t.to_user.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-neutral-700 dark:text-neutral-200 mb-1",children:"Asset Type"}),e.jsxs("select",{...x("kind"),className:l("input input-bordered w-full bg-white/80 dark:bg-zinc-800/70 text-neutral-900 dark:text-neutral-100 border-cyan-300 dark:border-cyan-700 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 px-4 py-2",t.kind&&"border-red-400 focus:border-red-500"),children:[e.jsx("option",{value:"credit",children:"Credit"}),e.jsx("option",{value:"khash",children:"KHash"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-neutral-700 dark:text-neutral-200 mb-1",children:"Amount"}),e.jsx("input",{type:"number",step:"0.01",...x("amount",{valueAsNumber:!0}),placeholder:"Amount",className:l("input input-bordered w-full bg-white/80 dark:bg-zinc-800/70 text-neutral-900 dark:text-neutral-100 border-cyan-300 dark:border-cyan-700 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 placeholder:text-neutral-400 dark:placeholder:text-neutral-500 px-4 py-2",t.amount&&"border-red-400 focus:border-red-500")}),t.amount&&e.jsx("span",{className:"text-red-500 text-xs mt-1 block",children:t.amount.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-neutral-700 dark:text-neutral-200 mb-1",children:"Reason"}),e.jsx("input",{...x("reason"),placeholder:"Reason for transfer",className:l("input input-bordered w-full bg-white/80 dark:bg-zinc-800/70 text-neutral-900 dark:text-neutral-100 border-cyan-300 dark:border-cyan-700 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 placeholder:text-neutral-400 dark:placeholder:text-neutral-500 px-4 py-2",t.reason&&"border-red-400 focus:border-red-500")}),t.reason&&e.jsx("span",{className:"text-red-500 text-xs mt-1 block",children:t.reason.message})]}),k&&e.jsx("div",{className:"text-red-500 text-xs mt-1 block",children:k}),e.jsxs("div",{className:"text-xs text-neutral-500 dark:text-neutral-400 mt-1",children:["Fee: ",T.toFixed(2)," | Total: ",A.toFixed(2)]}),e.jsx("button",{type:"submit",className:l("btn btn-primary bg-gradient-to-r from-cyan-500 to-purple-500 text-white font-bold py-2 rounded-lg shadow hover:from-cyan-600 hover:to-purple-600 transition-colors duration-200",y?"opacity-50 cursor-not-allowed":""),disabled:y,children:"Submit"})]}),o&&e.jsx("div",{className:"mt-4",children:o.error?e.jsxs("div",{className:"text-red-600 font-semibold bg-red-100 dark:bg-red-900/40 rounded-lg px-4 py-2",children:["Error: ",o.error.message||String(o.error)]}):e.jsx("div",{className:"text-green-700 font-semibold bg-green-100 dark:bg-green-900/40 rounded-lg px-4 py-2",children:"Transfer successful!"})}),c&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white/70 dark:bg-zinc-900/70 rounded-2xl p-8 shadow-2xl w-full max-w-sm flex flex-col items-center gap-5 border border-cyan-200 dark:border-zinc-800 backdrop-blur-lg",children:[e.jsx("h4",{className:"text-xl font-bold text-cyan-700 dark:text-cyan-200 mb-2",children:"Confirm Transfer"}),e.jsxs("div",{className:"text-base text-neutral-700 dark:text-neutral-200 mb-2 text-center",children:["Are you sure you want to send ",e.jsx("b",{className:"text-cyan-600 dark:text-cyan-300",children:r?.amount.toFixed(2)})," ",e.jsx("span",{className:"uppercase",children:r?.kind})," to ",e.jsx("b",{className:"text-purple-600 dark:text-purple-300",children:r?.to_user}),"?",e.jsx("br",{}),e.jsxs("span",{className:"italic text-sm text-neutral-500 dark:text-neutral-400",children:["Reason: ",r?.reason]})]}),e.jsx("input",{type:"text",placeholder:"Type CONFIRM to proceed",value:n,onChange:a=>u(a.target.value),className:"input input-bordered w-full text-center font-mono tracking-widest text-lg bg-white/80 dark:bg-zinc-800/70 text-neutral-900 dark:text-neutral-100 border-cyan-300 dark:border-cyan-700 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 placeholder:text-neutral-400 dark:placeholder:text-neutral-500 px-4 py-2"}),e.jsxs("div",{className:"flex gap-2 w-full mt-2",children:[e.jsx("button",{className:l("btn btn-primary flex-1 bg-gradient-to-r from-cyan-500 to-purple-500 text-white font-bold py-2 rounded-lg shadow",n!=="CONFIRM"&&"opacity-50 pointer-events-none"),onClick:M,disabled:n!=="CONFIRM",children:"Confirm"}),e.jsx("button",{className:"btn btn-secondary flex-1 bg-neutral-200 dark:bg-zinc-800 text-neutral-700 dark:text-neutral-200 rounded-lg",onClick:()=>{i(!1),u("")},children:"Cancel"})]})]})})]})};export{se as default};
