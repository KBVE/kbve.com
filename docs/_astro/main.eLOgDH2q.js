import{w as u,p as F,t as A}from"./comlink.CPG-Ccvr.js";import{a as B}from"./@nanostores.CJR83bEb.js";import{B as f,t as y}from"./flatbuffers.BcE9oV44.js";import{z as s}from"./zod.D6aOmuMC.js";import"./nanostores.qAfxXu-z.js";import"./react.CvslfkeK.js";import"./@react-three.B-wTPXHf.js";const H="data:video/mp2t;base64,aW1wb3J0IHsgZXhwb3NlIH0gZnJvbSAnY29tbGluayc7CgpleHBvcnQgaW50ZXJmYWNlIENhbnZhc1dvcmtlckFQSSB7CgliaW5kQ2FudmFzKHBhbmVsSWQ6IHN0cmluZywgY2FudmFzOiBPZmZzY3JlZW5DYW52YXMsIG1vZGU/OiBDYW52YXNEcmF3TW9kZSk6IFByb21pc2U8dm9pZD47Cgl1bmJpbmRDYW52YXMocGFuZWxJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPjsKfQoKaW50ZXJmYWNlIENhbnZhc0JpbmRpbmcgewoJY3R4OiBPZmZzY3JlZW5DYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7CgljYW52YXM6IE9mZnNjcmVlbkNhbnZhczsKCXBhbmVsSWQ6IHN0cmluZzsKCW1vZGU/OiBDYW52YXNEcmF3TW9kZTsKCWFuaW1hdGlvbkZyYW1lPzogbnVtYmVyOwp9CgpleHBvcnQgdHlwZSBDYW52YXNEcmF3TW9kZSA9ICdzdGF0aWMnIHwgJ2FuaW1hdGVkJyB8ICdkeW5hbWljJzsKCmNvbnN0IENhbnZhc01hbmFnZXIgPSB7CgliaW5kaW5nczogbmV3IE1hcDxzdHJpbmcsIENhbnZhc0JpbmRpbmc+KCksCgoJYXN5bmMgYmluZENhbnZhcyhwYW5lbElkOiBzdHJpbmcsIGNhbnZhczogT2Zmc2NyZWVuQ2FudmFzLCBtb2RlOiBDYW52YXNEcmF3TW9kZSA9ICdhbmltYXRlZCcpIHsKCQljb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJaWYgKCFjdHgpIHsKCQkJY29uc29sZS5lcnJvcihgW0NhbnZhc1dvcmtlcl0gRmFpbGVkIHRvIGdldCAyRCBjb250ZXh0IGZvciBwYW5lbCAke3BhbmVsSWR9YCk7CgkJCXJldHVybjsKCQl9CgoJCWNvbnNvbGUubG9nKGBbQ2FudmFzV29ya2VyXSBTdWNjZXNzZnVsbHkgYm91bmQgY2FudmFzIGZvciBwYW5lbCAke3BhbmVsSWR9IHdpdGggbW9kZSAke21vZGV9YCk7CgoJCXRoaXMuYmluZGluZ3Muc2V0KHBhbmVsSWQsIHsgY3R4LCBjYW52YXMsIHBhbmVsSWQsIG1vZGUgfSk7CgoJCXRoaXMuc3RhcnRBbmltYXRpb24ocGFuZWxJZCk7Cgl9LAoKCXN0YXJ0QW5pbWF0aW9uKHBhbmVsSWQ6IHN0cmluZykgewoJCWNvbnN0IGJpbmRpbmcgPSB0aGlzLmJpbmRpbmdzLmdldChwYW5lbElkKTsKCQlpZiAoIWJpbmRpbmcpIHJldHVybjsKCgkJc3dpdGNoIChiaW5kaW5nLm1vZGUpIHsKCQkJY2FzZSAnc3RhdGljJzoKCQkJCXRoaXMuZHJhd1N0YXRpYyhiaW5kaW5nKTsKCQkJCWJyZWFrOwoJCQljYXNlICdhbmltYXRlZCc6CgkJCQl0aGlzLmRyYXdBbmltYXRlZChiaW5kaW5nKTsKCQkJCWJyZWFrOwoJCQljYXNlICdkeW5hbWljJzoKCQkJCXRoaXMuZHJhd0R5bmFtaWMoYmluZGluZyk7CgkJCQlicmVhazsKCQkJZGVmYXVsdDoKCQkJCWNvbnNvbGUud2FybihgW0NhbnZhc1dvcmtlcl0gVW5rbm93biBkcmF3IG1vZGUgZm9yIHBhbmVsICR7cGFuZWxJZH1gKTsKCQl9Cgl9LAoKCWRyYXdTdGF0aWMoYmluZGluZzogQ2FudmFzQmluZGluZykgewoJCWJpbmRpbmcuY3R4LmZpbGxTdHlsZSA9ICdncmF5JzsKCQliaW5kaW5nLmN0eC5maWxsUmVjdCgwLCAwLCBiaW5kaW5nLmNhbnZhcy53aWR0aCwgYmluZGluZy5jYW52YXMuaGVpZ2h0KTsKCX0sCgoJZHJhd0FuaW1hdGVkKGJpbmRpbmc6IENhbnZhc0JpbmRpbmcpIHsKCQlsZXQgaHVlID0gMDsKCgkJY29uc3QgZHJhd0ZyYW1lID0gKCkgPT4gewoJCQlodWUgPSAoaHVlICsgMSkgJSAzNjA7CgkJCWJpbmRpbmcuY3R4LmZpbGxTdHlsZSA9IGBoc2woJHtodWV9LCAxMDAlLCA1MCUpYDsKCQkJYmluZGluZy5jdHguZmlsbFJlY3QoMCwgMCwgYmluZGluZy5jYW52YXMud2lkdGgsIGJpbmRpbmcuY2FudmFzLmhlaWdodCk7CgoJCQliaW5kaW5nLmFuaW1hdGlvbkZyYW1lID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRyYXdGcmFtZSk7CgkJfTsKCgkJZHJhd0ZyYW1lKCk7Cgl9LAoKCWRyYXdEeW5hbWljKGJpbmRpbmc6IENhbnZhc0JpbmRpbmcpIHsKCQlsZXQgdGltZSA9IDA7CgoJCWNvbnN0IGRyYXdGcmFtZSA9ICgpID0+IHsKCQkJdGltZSArPSAwLjA1OwoJCQliaW5kaW5nLmN0eC5jbGVhclJlY3QoMCwgMCwgYmluZGluZy5jYW52YXMud2lkdGgsIGJpbmRpbmcuY2FudmFzLmhlaWdodCk7CgkJCWJpbmRpbmcuY3R4LmJlZ2luUGF0aCgpOwoJCQliaW5kaW5nLmN0eC5hcmMoCgkJCQliaW5kaW5nLmNhbnZhcy53aWR0aCAvIDIgKyBNYXRoLnNpbih0aW1lKSAqIDUwLAoJCQkJYmluZGluZy5jYW52YXMuaGVpZ2h0IC8gMiArIE1hdGguY29zKHRpbWUpICogNTAsCgkJCQkzMCwKCQkJCTAsCgkJCQlNYXRoLlBJICogMgoJCQkpOwoJCQliaW5kaW5nLmN0eC5maWxsU3R5bGUgPSAnb3JhbmdlJzsKCQkJYmluZGluZy5jdHguZmlsbCgpOwoJCgkJCWJpbmRpbmcuYW5pbWF0aW9uRnJhbWUgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZHJhd0ZyYW1lKTsKCQl9OwoKCQlkcmF3RnJhbWUoKTsKCX0sCgoJYXN5bmMgdW5iaW5kQ2FudmFzKHBhbmVsSWQ6IHN0cmluZykgewoJCWNvbnN0IGJpbmRpbmcgPSB0aGlzLmJpbmRpbmdzLmdldChwYW5lbElkKTsKCQlpZiAoYmluZGluZz8uYW5pbWF0aW9uRnJhbWUpIHsKCQkJY2FuY2VsQW5pbWF0aW9uRnJhbWUoYmluZGluZy5hbmltYXRpb25GcmFtZSk7CgkJfQoJCXRoaXMuYmluZGluZ3MuZGVsZXRlKHBhbmVsSWQpOwoJCWNvbnNvbGUubG9nKGBbQ2FudmFzV29ya2VyXSBVbmJvdW5kIGNhbnZhcyBmb3IgcGFuZWwgJHtwYW5lbElkfWApOwoJfSwKfTsKCmV4cG9zZShDYW52YXNNYW5hZ2VyKTsK",E="/_astro/data.ELiKFXyc.ts",z="/_astro/db-worker.CwD_r7N7.ts",L="data:video/mp2t;base64,aW1wb3J0IHsgRHJvaWRFdmVudFNjaGVtYXMgfSBmcm9tICcuLi90eXBlcy9ldmVudC10eXBlcyc7CmltcG9ydCB0eXBlIHsgRHJvaWRFdmVudE1hcCwgRXZlbnRLZXksIEV2ZW50SGFuZGxlciAgfSBmcm9tICcuLi90eXBlcy9ldmVudC10eXBlcyc7CgppbXBvcnQgeyB6IH0gZnJvbSAnem9kJzsKCgpjbGFzcyBEcm9pZEV2ZW50QnVzIHsKICAgIHByaXZhdGUgbGlzdGVuZXJzID0gbmV3IE1hcDxFdmVudEtleSwgU2V0PChwYXlsb2FkOiB1bmtub3duKSA9PiB2b2lkPj4oKTsKCiAgICBvbjxLIGV4dGVuZHMgRXZlbnRLZXk+KGV2ZW50OiBLLCBoYW5kbGVyOiBFdmVudEhhbmRsZXI8Sz4pIHsKCQlsZXQgaGFuZGxlcnMgPSB0aGlzLmxpc3RlbmVycy5nZXQoZXZlbnQpOwogICAgICAgIGlmICghaGFuZGxlcnMpIHsKICAgICAgICAgICAgaGFuZGxlcnMgPSBuZXcgU2V0KCk7CiAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzLnNldChldmVudCwgaGFuZGxlcnMpOwogICAgICAgIH0KICAgICAgICBoYW5kbGVycy5hZGQoaGFuZGxlciBhcyAocGF5bG9hZDogdW5rbm93bikgPT4gdm9pZCk7Cgl9CgoJb2ZmPEsgZXh0ZW5kcyBFdmVudEtleT4oZXZlbnQ6IEssIGhhbmRsZXI6IEV2ZW50SGFuZGxlcjxLPikgewoJCXRoaXMubGlzdGVuZXJzLmdldChldmVudCk/LmRlbGV0ZShoYW5kbGVyIGFzIChwYXlsb2FkOiB1bmtub3duKSA9PiB2b2lkKTsKCX0KCgllbWl0PEsgZXh0ZW5kcyBFdmVudEtleT4oZXZlbnQ6IEssIHBheWxvYWQ6IERyb2lkRXZlbnRNYXBbS10pIHsKCQljb25zdCBzY2hlbWEgPSBEcm9pZEV2ZW50U2NoZW1hc1tldmVudF07CgkJaWYgKHNjaGVtYSkgewoJCQl0cnkgewoJCQkJc2NoZW1hLnBhcnNlKHBheWxvYWQpOwoJCQl9IGNhdGNoIChlcnIpIHsKCQkJCWNvbnNvbGUuZXJyb3IoYFtEcm9pZEV2ZW50QnVzXSBJbnZhbGlkIHBheWxvYWQgZm9yICR7ZXZlbnR9OmAsIGVycik7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCXdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChldmVudCwgeyBkZXRhaWw6IHBheWxvYWQgfSkpOwoKCQlmb3IgKGNvbnN0IGhhbmRsZXIgb2YgdGhpcy5saXN0ZW5lcnMuZ2V0KGV2ZW50KSA/PyBbXSkgewoJCQkoaGFuZGxlciBhcyBFdmVudEhhbmRsZXI8Sz4pKHBheWxvYWQpOwoJCX0KCX0KCgl3YWl0PEsgZXh0ZW5kcyBFdmVudEtleT4oZXZlbnQ6IEspOiBQcm9taXNlPERyb2lkRXZlbnRNYXBbS10+IHsKCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKCQkJY29uc3QgZm46IEV2ZW50SGFuZGxlcjxLPiA9IChwYXlsb2FkKSA9PiB7CgkJCQl0aGlzLm9mZihldmVudCwgZm4pOwoJCQkJcmVzb2x2ZShwYXlsb2FkKTsKCQkJfTsKCQkJdGhpcy5vbihldmVudCwgZm4pOwoJCX0pOwoJfQp9CgpleHBvcnQgY29uc3QgRHJvaWRFdmVudHMgPSBuZXcgRHJvaWRFdmVudEJ1cygpOwo=",U="data:video/mp2t;base64,aW1wb3J0IHsgQnVpbGRlciBhcyBGbGV4QnVpbGRlciB9IGZyb20gJ2ZsYXRidWZmZXJzL3RzL2ZsZXhidWZmZXJzL2J1aWxkZXInOwpleHBvcnQgeyB0b1JlZmVyZW5jZSB9IGZyb20gJ2ZsYXRidWZmZXJzL3RzL2ZsZXhidWZmZXJzL3JlZmVyZW5jZSc7CgpleHBvcnQgZnVuY3Rpb24gYnVpbGRlcigpOiBGbGV4QnVpbGRlciB7CiAgcmV0dXJuIG5ldyBGbGV4QnVpbGRlcigpOwp9",T="data:video/mp2t;base64,aW1wb3J0IHR5cGUgeyBSZW1vdGUgfSBmcm9tICdjb21saW5rJwppbXBvcnQgdHlwZSB7IExvY2FsU3RvcmFnZUFQSSB9IGZyb20gJy4vZGItd29ya2VyJwoKZXhwb3J0IGludGVyZmFjZSBJbml0V29ya2VyT3B0aW9ucyB7Cgl2ZXJzaW9uOiBzdHJpbmcKCWkxOG5QYXRoPzogc3RyaW5nCglsb2NhbGU/OiBzdHJpbmcKCWRlZmF1bHRzPzogUmVjb3JkPHN0cmluZywgYW55Pgp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZVdvcmtlckRhdGFiYXNlKAoJd29ya2VyOiBSZW1vdGU8TG9jYWxTdG9yYWdlQVBJPiwKCXsKCQl2ZXJzaW9uLAoJCWkxOG5QYXRoID0gJ2h0dHBzOi8vZGlzY29yZC5zaC9pMThuL2RiLmpzb24nLAoJCWxvY2FsZSA9ICdlbicsCgkJZGVmYXVsdHMgPSB7CgkJCXdlbGNvbWU6ICdXZWxjb21lIHRvIHRoZSBhcHAhJywKCQl9LAoJfTogSW5pdFdvcmtlck9wdGlvbnMKKSB7Cgljb25zb2xlLmxvZygnW2luaXQtd29ya2VyXSBJbml0aWFsaXppbmcgZGF0YWJhc2UuLi4nKQoKCXRyeSB7CgkJYXdhaXQgd29ya2VyLmxvYWRJMThuRnJvbUpTT04oaTE4blBhdGgpCgkJY29uc29sZS5sb2coYFtpbml0LXdvcmtlcl0gaTE4biBsb2FkZWQgZnJvbSAke2kxOG5QYXRofWApCgoJCWF3YWl0IHdvcmtlci5kYlNldCgnbG9jYWxlJywgbG9jYWxlKQoKCQlmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkZWZhdWx0cykpIHsKCQkJYXdhaXQgd29ya2VyLmRiU2V0KGtleSwgdmFsdWUpCgkJfQoKCQlhd2FpdCB3b3JrZXIuc2V0VmVyc2lvbih2ZXJzaW9uKQoJCXZvaWQgd29ya2VyLmxvYWRTZXJ2ZXJzRnJvbUpTT04oKTsgLy8gYXdhaXQgd29ya2VyLmxvYWRTZXJ2ZXJzRnJvbUpTT04oKTsKCQljb25zb2xlLmxvZyhgW2luaXQtd29ya2VyXSBEQiBpbml0aWFsaXplZCB0byB2ZXJzaW9uICR7dmVyc2lvbn1gKQoJfSBjYXRjaCAoZXJyKSB7CgkJY29uc29sZS5lcnJvcignW2luaXQtd29ya2VyXSBJbml0aWFsaXphdGlvbiBmYWlsZWQ6JywgZXJyKQoJfQp9Cg==",j="data:video/mp2t;base64,aW1wb3J0IHR5cGUgeyBWaXJ0dWFsTm9kZSB9IGZyb20gJy4uL3R5cGVzL21vZHVsZXMnOwoKZXhwb3J0IGZ1bmN0aW9uIGRpc3BhdGNoQXN5bmMoZm46ICgpID0+IHZvaWQpIHsKCWlmICh0eXBlb2YgcXVldWVNaWNyb3Rhc2sgPT09ICdmdW5jdGlvbicpIHsKCQlxdWV1ZU1pY3JvdGFzayhmbik7Cgl9IGVsc2UgewoJCXNldFRpbWVvdXQoZm4sIDApOwoJfQp9CgpleHBvcnQgZnVuY3Rpb24gcmVuZGVyVk5vZGUodm5vZGU6IFZpcnR1YWxOb2RlKTogSFRNTEVsZW1lbnQgewoJY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHZub2RlLnRhZyk7CgoJaWYgKHZub2RlLmNsYXNzKSBlbC5jbGFzc05hbWUgPSB2bm9kZS5jbGFzczsKCglpZiAodm5vZGUuYXR0cnMpIHsKCQlmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh2bm9kZS5hdHRycykpIHsKCQkJaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiBrZXkuc3RhcnRzV2l0aCgnb24nKSkgewoJCQkJZWwuYWRkRXZlbnRMaXN0ZW5lcihrZXkuc2xpY2UoMikudG9Mb3dlckNhc2UoKSwgdmFsdWUpOwoJCQl9IGVsc2UgaWYgKGtleSA9PT0gJ3N0eWxlJyAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7CgkJCQlPYmplY3QuYXNzaWduKGVsLnN0eWxlLCB2YWx1ZSk7CgkJCX0gZWxzZSBpZiAoa2V5ID09PSAnZGF0YXNldCcgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JykgewoJCQkJZm9yIChjb25zdCBbZGF0YV9rZXksIGRhdGFfdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHZhbHVlKSkgewoJCQkJCWVsLmRhdGFzZXRbZGF0YV9rZXldID0gU3RyaW5nKGRhdGFfdmFsdWUpOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdHJ5IHsKCQkJCQllbC5zZXRBdHRyaWJ1dGUoa2V5LCBTdHJpbmcodmFsdWUpKTsKCQkJCX0gY2F0Y2ggewoJCQkJCS8vCgkJCQl9CgkJCX0KCQl9Cgl9CgoJaWYgKHZub2RlLnN0eWxlKSB7CgkJT2JqZWN0LmFzc2lnbihlbC5zdHlsZSwgdm5vZGUuc3R5bGUpOwoJfQoKCS8vIGlmICh2bm9kZS5jaGlsZHJlbikgewoJLy8gCWZvciAoY29uc3QgY2hpbGQgb2Ygdm5vZGUuY2hpbGRyZW4pIHsKCS8vIAkJZWwuYXBwZW5kQ2hpbGQoCgkvLyAJCQl0eXBlb2YgY2hpbGQgPT09ICdzdHJpbmcnCgkvLyAJCQkJPyBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjaGlsZCkKCS8vIAkJCQk6IHJlbmRlclZOb2RlKGNoaWxkKSwKCS8vIAkJKTsKCS8vIAl9CgkvLyB9CgoJaWYgKHZub2RlLmNoaWxkcmVuKSB7CgkJZm9yIChjb25zdCBjaGlsZCBvZiB2bm9kZS5jaGlsZHJlbikgewoJCQljb25zdCBub2RlID0gdHlwZW9mIGNoaWxkID09PSAnc3RyaW5nJwoJCQkJPyBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjaGlsZCkKCQkJCTogcmVuZGVyVk5vZGUoY2hpbGQpOwoJCQllbC5hcHBlbmRDaGlsZChub2RlKTsKCQl9Cgl9CgoJcmV0dXJuIGVsOwp9Cg==",O="data:video/mp2t;base64,aW1wb3J0IHsgd3JhcCwgZXhwb3NlLCB0eXBlIFJlbW90ZSB9IGZyb20gJ2NvbWxpbmsnOwppbXBvcnQgdHlwZSB7IExvY2FsU3RvcmFnZUFQSSB9IGZyb20gJy4vZGItd29ya2VyJzsKaW1wb3J0IHsgdG9SZWZlcmVuY2UsIGJ1aWxkZXIgfSBmcm9tICcuL2ZsZXhidWlsZGVyJzsKCgppbnRlcmZhY2UgU2hhcmVkV29ya2VyR2xvYmFsU2NvcGUgZXh0ZW5kcyBXb3JrZXIgewoJb25jb25uZWN0OiAoZXZlbnQ6IE1lc3NhZ2VFdmVudCkgPT4gdm9pZDsKfQpkZWNsYXJlIGNvbnN0IHNlbGY6IFNoYXJlZFdvcmtlckdsb2JhbFNjb3BlOwoKCmxldCB3czogV2ViU29ja2V0IHwgbnVsbCA9IG51bGw7CmxldCBvbk1lc3NhZ2VDYWxsYmFjazogKChkYXRhOiBhbnkpID0+IHZvaWQpIHwgbnVsbCA9IG51bGw7CgoKLy8gLS0tIFdlYlNvY2tldCBBUEkgLS0tCmNvbnN0IHdzSW5zdGFuY2VBUEkgPSB7Cglhc3luYyBjb25uZWN0KHVybDogc3RyaW5nKSB7CgkJaWYgKHdzKSByZXR1cm47CgoJCXdzID0gbmV3IFdlYlNvY2tldCh1cmwpOwoJCXdzLmJpbmFyeVR5cGUgPSAnYXJyYXlidWZmZXInOwoKCQl3cy5vbm9wZW4gPSAoKSA9PiBjb25zb2xlLmxvZygnW1dTXSBDb25uZWN0ZWQ6JywgdXJsKTsKCiAgICAgICAgd3Mub25tZXNzYWdlID0gKGUpID0+IHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbV1NdIFJlY2VpdmVkIGJpbmFyeSBtZXNzYWdlJyk7CgkJCQkKCQkJCWlmIChlLmRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewoJCQkJCW9uTWVzc2FnZUNhbGxiYWNrPy4oZS5kYXRhKTsgICAKCQkJCX0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbV1NdIEZhaWxlZCB0byBmb3J3YXJkIG1lc3NhZ2UnLCBlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKIAoKCQl3cy5vbmVycm9yID0gKGUpID0+IGNvbnNvbGUuZXJyb3IoJ1tXU10gRXJyb3I6JywgZSk7CgkJd3Mub25jbG9zZSA9ICgpID0+IHsKCQkJY29uc29sZS5sb2coJ1tXU10gRGlzY29ubmVjdGVkJyk7CgkJCXdzID0gbnVsbDsKCQl9OwoJfSwKCglhc3luYyBzZW5kKHBheWxvYWQ6IFVpbnQ4QXJyYXkpIHsKCQlpZiAod3M/LnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7CgkJCXdzLnNlbmQocGF5bG9hZCk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS53YXJuKCdbV1NdIFRyaWVkIHRvIHNlbmQgd2hpbGUgZGlzY29ubmVjdGVkJyk7CgkJfQoJfSwKCglhc3luYyBjbG9zZSgpIHsKCQl3cz8uY2xvc2UoKTsKCQl3cyA9IG51bGw7Cgl9LAoKCW9uTWVzc2FnZShjYWxsYmFjazogKGRhdGE6IGFueSkgPT4gdm9pZCkgewoJCW9uTWVzc2FnZUNhbGxiYWNrID0gY2FsbGJhY2s7Cgl9LAoKCn07CgpleHBvcnQgdHlwZSBXU0luc3RhbmNlID0gdHlwZW9mIHdzSW5zdGFuY2VBUEk7CgpzZWxmLm9uY29ubmVjdCA9IChldmVudDogTWVzc2FnZUV2ZW50KSA9PiB7Cgljb25zdCBwb3J0ID0gZXZlbnQucG9ydHNbMF07Cglwb3J0LnN0YXJ0KCk7CglleHBvc2Uod3NJbnN0YW5jZUFQSSwgcG9ydCk7Cn07Cgo=";async function D(e,{version:o,i18nPath:t="https://discord.sh/i18n/db.json",locale:n="en",defaults:d={welcome:"Welcome to the app!"}}){console.log("[init-worker] Initializing database...");try{await e.loadI18nFromJSON(t),console.log(`[init-worker] i18n loaded from ${t}`),await e.dbSet("locale",n);for(const[a,l]of Object.entries(d))await e.dbSet(a,l);await e.setVersion(o),e.loadServersFromJSON(),console.log(`[init-worker] DB initialized to version ${o}`)}catch(a){console.error("[init-worker] Initialization failed:",a)}}let W=null;async function x(e){if(W)return W;const o={};async function t(l){const i=e?.(l)??l,C=new Worker(i,{type:"module"}),h=u(C),J=await h.getMeta?.()??{name:"unknown",version:"0.0.1"},I=`${J.name}@${J.version}`;console.log(`[mod-manager] ${I} is loaded.`);const G={id:I,worker:C,instance:h,meta:J,url:l};return o[I]=G,G}function n(l){o[l]&&(o[l].worker.terminate(),delete o[l])}function d(){return Object.values(o).map(l=>l.meta)}async function a(l){const i=o[l];if(!i)throw new Error(`Mod "${l}" not found`);return n(l),t(i.url)}return W={registry:o,load:t,unload:n,list:d,reload:a},W}var r=(e=>(e[e.PAYLOAD_UNKNOWN=0]="PAYLOAD_UNKNOWN",e[e.JSON=1]="JSON",e[e.FLEX=2]="FLEX",e[e.PROTOBUF=3]="PROTOBUF",e[e.FLATBUFFER=4]="FLATBUFFER",e))(r||{}),c=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.ADD=1]="ADD",e[e.READ=2]="READ",e[e.GET=4]="GET",e[e.SET=8]="SET",e[e.DEL=16]="DEL",e[e.STREAM=32]="STREAM",e[e.GROUP=64]="GROUP",e[e.LIST=128]="LIST",e[e.ACTION=256]="ACTION",e[e.MESSAGE=512]="MESSAGE",e[e.INFO=1024]="INFO",e[e.DEBUG=2048]="DEBUG",e[e.ERROR=4096]="ERROR",e[e.AUTH=8192]="AUTH",e[e.HEARTBEAT=16384]="HEARTBEAT",e[e.CONFIG_UPDATE=32768]="CONFIG_UPDATE",e[e.REDIS=65536]="REDIS",e[e.SUPABASE=131072]="SUPABASE",e[e.FILESYSTEM=262144]="FILESYSTEM",e[e.WEBSOCKET=524288]="WEBSOCKET",e[e.HTTP_API=1048576]="HTTP_API",e[e.LOCAL_CACHE=2097152]="LOCAL_CACHE",e[e.AI=4194304]="AI",e))(c||{});function p(){return new f}function P(e){const o=p();o.startMap();for(const[t,n]of Object.entries(e))o.addKey(t),o.add(n);return o.end(),o.finish()}function Z(e,o,t,n,d=1){let a;if(t===r.FLEX)a=P(e);else if(t===r.JSON)a=new TextEncoder().encode(JSON.stringify(e));else throw new Error("Unsupported format for wrapEnvelope");const l=p();return l.startMap(),l.addKey("version"),l.add(d),l.addKey("kind"),l.add(o),l.addKey("format"),l.add(t),l.addKey("payload"),l.add(a),l.addKey("metadata"),l.add(n??new Uint8Array),l.end(),l.finish()}function S(e){const o=e instanceof Uint8Array?e:new Uint8Array(e),t=y(o.buffer).toObject();if(typeof t.version!="number"||typeof t.kind!="number"||typeof t.format!="number"||!t.payload)throw console.error("[unwrapEnvelope] Bad root:",t),new Error("[unwrapEnvelope] Invalid envelope structure");const n={version:t.version,kind:t.kind,format:t.format,payload:new Uint8Array(t.payload),metadata:t.metadata?new Uint8Array(t.metadata):void 0};let d;if(n.format===r.FLEX)d=y(n.payload.buffer).toObject();else if(n.format===r.JSON)d=JSON.parse(new TextDecoder().decode(n.payload));else throw new Error(`[unwrapEnvelope] Unsupported format: ${n.format}`);return{envelope:n,payload:d}}function V(e){return y(e.buffer).toObject()}function M(e){try{const o=e instanceof Uint8Array?e:new Uint8Array(e),t=V(o);console.log("[FlexObject]",JSON.stringify(t,null,2))}catch(o){console.error("[Flex Decode Error]",o)}}function Q(e,o){return(e&o)===o}function _(e,o){return Z({key:e,value:o},c.SET|c.REDIS,r.FLEX)}function $(e){return Z({key:e},c.GET|c.REDIS,r.FLEX)}function q(e){return Z({key:e},c.DEL|c.REDIS,r.FLEX)}function ee(e){const o=S(e);if(!Q(o.envelope.kind,c.REDIS))throw new Error("[Redis] Not a Redis envelope");return o}function oe(e,o,t="*"){return Z({stream:e,id:t,fields:o},c.ADD|c.STREAM|c.REDIS,r.FLEX)}function te(e,o,t){const n=p();n.startMap(),n.addKey("streams"),n.startVector();for(const{stream:l,id:i}of e)n.startMap(),n.addKey("stream"),n.add(l),n.addKey("id"),n.add(i),n.end();n.end(),o!==void 0&&(n.addKey("count"),n.add(o)),t!==void 0&&(n.addKey("block"),n.add(t)),n.end();const d=n.finish(),a=p();return a.startMap(),a.addKey("version"),a.add(1),a.addKey("kind"),a.add(c.READ|c.STREAM|c.REDIS),a.addKey("format"),a.add(r.FLEX),a.addKey("payload"),a.add(d),a.addKey("metadata"),a.add(new Uint8Array),a.end(),a.finish()}const ne={wrapEnvelope:Z,unwrapEnvelope:S,MessageKind:c,PayloadFormat:r,unwrapFlexToJson:V,inspectFlex:M,hasKind:Q,redis:{wrapRedisSet:_,wrapRedisGet:$,wrapRedisDel:q,wrapRedisXAdd:oe,wrapRedisXRead:te,parseRedisPayload:ee}};function K(e){typeof queueMicrotask=="function"?queueMicrotask(e):setTimeout(e,0)}function N(e){const o=document.createElement(e.tag);if(e.class&&(o.className=e.class),e.attrs)for(const[t,n]of Object.entries(e.attrs))if(typeof n=="function"&&t.startsWith("on"))o.addEventListener(t.slice(2).toLowerCase(),n);else if(t==="style"&&typeof n=="object")Object.assign(o.style,n);else if(t==="dataset"&&typeof n=="object")for(const[d,a]of Object.entries(n))o.dataset[d]=String(a);else try{o.setAttribute(t,String(n))}catch{}if(e.style&&Object.assign(o.style,e.style),e.children)for(const t of e.children){const n=typeof t=="string"?document.createTextNode(t):N(t);o.appendChild(n)}return o}const le=s.enum(["top","right","bottom","left"]),ae=s.object({width:s.number(),height:s.number(),mode:s.enum(["static","animated","dynamic"]).optional()});s.object({rawHtml:s.string().optional(),needsCanvas:s.boolean().optional(),canvasOptions:ae.optional()});const de=s.object({name:s.string(),version:s.string().optional()}),se=s.object({meta:de.optional(),timestamp:s.number()}),X=s.object({id:le,payload:s.any().optional()}),ce=s.object({timestamp:s.number()}),be={"droid-ready":ce,"droid-mod-ready":se,"panel-open":X,"panel-close":X};class re{listeners=new Map;on(o,t){let n=this.listeners.get(o);n||(n=new Set,this.listeners.set(o,n)),n.add(t)}off(o,t){this.listeners.get(o)?.delete(t)}emit(o,t){const n=be[o];if(n)try{n.parse(t)}catch(d){console.error(`[DroidEventBus] Invalid payload for ${o}:`,d);return}window.dispatchEvent(new CustomEvent(o,{detail:t}));for(const d of this.listeners.get(o)??[])d(t)}wait(o){return new Promise(t=>{const n=d=>{this.off(o,n),t(d)};this.on(o,n)})}}const Ce=new re,Y="1.0.3";function k(e,o){try{return new URL(Object.assign({"./canvas-worker.ts":H,"./data.ts":E,"./db-worker.ts":z,"./events.ts":L,"./flexbuilder.ts":U,"./init.ts":T,"./tools.ts":j,"./ws-worker.ts":O})[`./${e}`],import.meta.url).toString()}catch{return`/${e}`}}async function ie(e){const o=e??k("ws-worker.js"),t=new SharedWorker(o,{type:"module"});return t.port.start(),u(t.port)}const b=B("uiux-state",{panelManager:{top:{open:!1},right:{open:!1},bottom:{open:!1},left:{open:!1}},themeManager:{theme:"auto"},toastManager:{},scrollY:0},{encode:JSON.stringify,decode:JSON.parse});async function me(e){const o=e??k("canvas-worker.js"),t=new Worker(o,{type:"module"});return u(t)}const w={state:b,openPanel(e,o){const t={...b.get().panelManager};t[e]={open:!0,payload:o},b.setKey("panelManager",t)},closePanel(e){const o={...b.get().panelManager};o[e]={open:!1,payload:void 0},b.setKey("panelManager",o)},togglePanel(e,o){const t={...b.get().panelManager},n=t[e]?.open??!1;t[e]={open:!n,payload:n?void 0:o},b.setKey("panelManager",t)},setTheme(e){b.setKey("themeManager",{theme:e})},addToast(e,o){const t={...b.get().toastManager,[e]:o};b.setKey("toastManager",t)},removeToast(e){const o={...b.get().toastManager};delete o[e],b.setKey("toastManager",o)},async dispatchCanvasRequest(e,o,t="animated"){const n=o.transferControlToOffscreen();await window.kbve?.uiux?.worker?.bindCanvas(e,n,t)},closeAllPanels(){const e={...b.get().panelManager};console.log("error panel is closing");for(const o of Object.keys(e))e[o]={open:!1,payload:void 0};b.setKey("panelManager",e)},emitFromWorker(e){e.type==="injectVNode"&&e.vnode&&K(()=>{const o=document.getElementById("bento-grid-inject");if(!o){console.warn("[KBVE] No injection target found: #bento-grid-inject");return}const t=N(e.vnode);if(t.classList.add("animate-fade-in"),e.vnode.id){const n=document.getElementById(e.vnode.id);n&&n.remove()}o.appendChild(t)})}},m=B("i18n-cache",{},{encode:JSON.stringify,decode:JSON.parse}),g={store:m,api:null,ready:Promise.resolve(),get(e){return m.get()[e]??`[${e}]`},async getAsync(e){const o=m.get()[e];if(o!==void 0)return o;if(!this.api)return`[${e}]`;const t=await this.api.getTranslation(e);return t!==null?(m.setKey(e,t),t):`[${e}]`},set(e,o){m.setKey(e,o)},async hydrate(e,o){this.api=e;for(const t of o){const n=await e.getTranslation(t);n!==null&&m.setKey(t,n)}},async hydrateLocale(e="en"){if(!this.api)return;const t=(await this.api.getAllI18nKeys()).filter(d=>d.startsWith(`${e}:`)),n=await this.api.getTranslations(t);for(const[d,a]of Object.entries(n))console.log(`[i18n.setKey] ${d} = ${a}`),this.store.setKey(d,a)}};function R(){if(!navigator.serviceWorker?.controller)return;const e=new MessageChannel;navigator.serviceWorker.controller.postMessage(e.port2,[e.port2]),e.port1.start()}async function ge(e){const o=e??k("db-worker.js"),t=new SharedWorker(o,{type:"module"});t.port.start();const n=u(t.port);return await n.getVersion()!==Y&&await D(n,{version:Y,i18nPath:"https://discord.sh/i18n/db.json",locale:"en",defaults:{welcome:"Welcome!",theme:"dark"}}),n}let v=!1;function Ze(e,o){const t=F(async n=>{K(()=>{const d=`ws:${Date.now()}`;o.storeWsMessage(d,n)})});e.onMessage(A(t,[0]))}async function he(e){if(v||(v=!0,navigator.serviceWorker?.controller?R():navigator.serviceWorker?.addEventListener("controllerchange",R)),!window.kbve?.api||!window.kbve?.i18n||!window.kbve?.uiux){const t=await me(e?.workerURLs?.canvasWorker),n=await ge(e?.workerURLs?.dbWorker),d=await ie(e?.workerURLs?.wsWorker),a=await x(C=>e?.workerURLs?.[C]??C),l=Ce;for(const C of Object.values(a.registry))typeof C.instance.init=="function"&&await C.instance.init({emitFromWorker:w.emitFromWorker}),console.log("[Event] -> Fire Mod Ready"),l.emit("droid-mod-ready",{meta:C.meta,timestamp:Date.now()});Ze(d,n);const i=ne;g.api=n,g.ready=g.hydrateLocale("en"),window.kbve={...window.kbve||{},api:n,i18n:g,uiux:{...w,worker:t},ws:d,data:i,mod:a,events:l},await g.ready,window.kbve.events.emit("droid-ready",{timestamp:Date.now()}),document.addEventListener("astro:page-load",()=>{console.debug("[KBVE] Re-dispatched droid-ready after astro:page-load"),window.kbve?.events.emit("droid-ready",{timestamp:Date.now()})}),console.log("[KBVE] Global API ready")}else console.log("[KBVE] Already initialized")}export{Ze as bridgeWsToDb,g as i18n,he as main,w as uiux};
