let d=0,p=[];function o(){return d+=1,()=>{if(d-=1,d===0){let e=p;p=[];for(let s of e)s()}}}function m(e){let s=o();return e().finally(s)}let u=[],c=(e,s)=>{let l=[],n={get(){return n.lc||n.listen(()=>{})(),n.value},l:0,lc:0,listen(i,f){return n.lc=l.push(i,f||n.l)/2,()=>{let t=l.indexOf(i);~t&&(l.splice(t,2),--n.lc||n.off())}},notify(i){let f=!u.length;for(let t=0;t<l.length;t+=2)u.push(l[t],l[t+1],n.value,i);if(f){for(let t=0;t<u.length;t+=4){let v;for(let h=t+1;!v&&(h+=4)<u.length;)u[h]<u[t+1]&&(v=u.push(u[t],u[t+1],u[t+2],u[t+3]));v||u[t](u[t+2],u[t+3])}u.length=0}},off(){},set(i){n.value!==i&&(n.value=i,n.notify())},subscribe(i,f){let t=n.listen(i,f);return i(n.value),t},value:e};return n};const T=5,a=6,r=10;let g=(e,s,l,n)=>(e.events=e.events||{},e.events[l+r]||(e.events[l+r]=n(i=>{e.events[l].reduceRight((f,t)=>(t(f),f),{shared:{},...i})})),e.events[l]=e.events[l]||[],e.events[l].push(s),()=>{let i=e.events[l],f=i.indexOf(s);i.splice(f,1),i.length||(delete e.events[l],e.events[l+r](),delete e.events[l+r])}),O=1e3,N=(e,s)=>g(e,n=>{let i=s(n);i&&e.events[a].push(i)},T,n=>{let i=e.listen;e.listen=(...t)=>(!e.lc&&!e.active&&(e.active=!0,n()),i(...t));let f=e.off;return e.events[a]=[],e.off=()=>{f(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let t of e.events[a])t();e.events[a]=[]}},O)},()=>{e.listen=i,e.off=f}});function U(e,s,l){let n=new Set([...s,void 0]);return e.listen((i,f)=>{n.has(f)&&l(i,f)})}let x=(e={})=>{let s=c(e);return s.setKey=function(l,n){typeof n>"u"?l in s.value&&(s.value={...s.value},delete s.value[l],s.notify(l)):s.value[l]!==n&&(s.value={...s.value,[l]:n},s.notify(l))},s};export{c as a,U as l,x as m,N as o,m as t};
