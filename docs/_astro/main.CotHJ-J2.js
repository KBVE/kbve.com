import{w as c,p as F,t as B}from"./comlink.CPG-Ccvr.js";import{a as T}from"./@nanostores.BsSnFId4.js";import{B as P,t as v}from"./flatbuffers.BcE9oV44.js";import{z as s}from"./zod.D6aOmuMC.js";import"./react.CvslfkeK.js";import"./@react-three.B-wTPXHf.js";import"./nanostores.Bo9-_MAV.js";async function x(e,{version:t,i18nPath:r="https://discord.sh/i18n/db.json",locale:o="en",defaults:i={welcome:"Welcome to the app!"}}){console.log("[init-worker] Initializing database...");try{await e.loadI18nFromJSON(r),console.log(`[init-worker] i18n loaded from ${r}`),await e.dbSet("locale",o);for(const[a,n]of Object.entries(i))await e.dbSet(a,n);await e.setVersion(t),e.loadServersFromJSON(),console.log(`[init-worker] DB initialized to version ${t}`)}catch(a){console.error("[init-worker] Initialization failed:",a)}}let R=null;async function z(e){if(R)return R;const t={};async function r(n){const u=e?.(n)??n,f=new Worker(u,{type:"module"}),O=c(f),D=await O.getMeta?.()??{name:"unknown",version:"0.0.1"},E=`${D.name}@${D.version}`;console.log(`[mod-manager] ${E} is loaded.`);const b={id:E,worker:f,instance:O,meta:D,url:n};return t[E]=b,b}function o(n){t[n]&&(t[n].worker.terminate(),delete t[n])}function i(){return Object.values(t).map(n=>n.meta)}async function a(n){const u=t[n];if(!u)throw new Error(`Mod "${n}" not found`);return o(n),r(u.url)}return R={registry:t,load:r,unload:o,list:i,reload:a},R}var w=(e=>(e[e.PAYLOAD_UNKNOWN=0]="PAYLOAD_UNKNOWN",e[e.JSON=1]="JSON",e[e.FLEX=2]="FLEX",e[e.PROTOBUF=3]="PROTOBUF",e[e.FLATBUFFER=4]="FLATBUFFER",e))(w||{}),l=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.ADD=1]="ADD",e[e.READ=2]="READ",e[e.GET=4]="GET",e[e.SET=8]="SET",e[e.DEL=16]="DEL",e[e.STREAM=32]="STREAM",e[e.GROUP=64]="GROUP",e[e.LIST=128]="LIST",e[e.ACTION=256]="ACTION",e[e.MESSAGE=512]="MESSAGE",e[e.INFO=1024]="INFO",e[e.DEBUG=2048]="DEBUG",e[e.ERROR=4096]="ERROR",e[e.AUTH=8192]="AUTH",e[e.HEARTBEAT=16384]="HEARTBEAT",e[e.CONFIG_UPDATE=32768]="CONFIG_UPDATE",e[e.REDIS=65536]="REDIS",e[e.SUPABASE=131072]="SUPABASE",e[e.FILESYSTEM=262144]="FILESYSTEM",e[e.WEBSOCKET=524288]="WEBSOCKET",e[e.HTTP_API=1048576]="HTTP_API",e[e.LOCAL_CACHE=2097152]="LOCAL_CACHE",e[e.AI=4194304]="AI",e))(l||{});function h(){return new P}function $(e){const t=h();t.startMap();for(const[r,o]of Object.entries(e))t.addKey(r),t.add(o);return t.end(),t.finish()}function y(e,t,r,o,i=1){let a;if(r===w.FLEX)a=$(e);else if(r===w.JSON)a=new TextEncoder().encode(JSON.stringify(e));else throw new Error("Unsupported format for wrapEnvelope");const n=h();return n.startMap(),n.addKey("version"),n.add(i),n.addKey("kind"),n.add(t),n.addKey("format"),n.add(r),n.addKey("payload"),n.add(a),n.addKey("metadata"),n.add(o??new Uint8Array),n.end(),n.finish()}function W(e){const t=e instanceof Uint8Array?e:new Uint8Array(e),r=v(t.buffer).toObject();if(typeof r.version!="number"||typeof r.kind!="number"||typeof r.format!="number"||!r.payload)throw console.error("[unwrapEnvelope] Bad root:",r),new Error("[unwrapEnvelope] Invalid envelope structure");const o={version:r.version,kind:r.kind,format:r.format,payload:new Uint8Array(r.payload),metadata:r.metadata?new Uint8Array(r.metadata):void 0};let i;if(o.format===w.FLEX)i=v(o.payload.buffer).toObject();else if(o.format===w.JSON)i=JSON.parse(new TextDecoder().decode(o.payload));else throw new Error(`[unwrapEnvelope] Unsupported format: ${o.format}`);return{envelope:o,payload:i}}function g(e){return v(e.buffer).toObject()}function J(e){try{const t=e instanceof Uint8Array?e:new Uint8Array(e),r=g(t);console.log("[FlexObject]",JSON.stringify(r,null,2))}catch(t){console.error("[Flex Decode Error]",t)}}function j(e,t){return(e&t)===t}function G(e,t){return y({key:e,value:t},l.SET|l.REDIS,w.FLEX)}function _(e){return y({key:e},l.GET|l.REDIS,w.FLEX)}function X(e){return y({key:e},l.DEL|l.REDIS,w.FLEX)}function V(e){const t=W(e);if(!j(t.envelope.kind,l.REDIS))throw new Error("[Redis] Not a Redis envelope");return t}function H(e,t,r="*"){return y({stream:e,id:r,fields:t},l.ADD|l.STREAM|l.REDIS,w.FLEX)}function M(e,t,r){const o=h();o.startMap(),o.addKey("streams"),o.startVector();for(const{stream:n,id:u}of e)o.startMap(),o.addKey("stream"),o.add(n),o.addKey("id"),o.add(u),o.end();o.end(),t!==void 0&&(o.addKey("count"),o.add(t)),r!==void 0&&(o.addKey("block"),o.add(r)),o.end();const i=o.finish(),a=h();return a.startMap(),a.addKey("version"),a.add(1),a.addKey("kind"),a.add(l.READ|l.STREAM|l.REDIS),a.addKey("format"),a.add(w.FLEX),a.addKey("payload"),a.add(i),a.addKey("metadata"),a.add(new Uint8Array),a.end(),a.finish()}const Y={wrapEnvelope:y,unwrapEnvelope:W,MessageKind:l,PayloadFormat:w,unwrapFlexToJson:g,inspectFlex:J,hasKind:j,redis:{wrapRedisSet:G,wrapRedisGet:_,wrapRedisDel:X,wrapRedisXAdd:H,wrapRedisXRead:M,parseRedisPayload:V}};function N(e){typeof queueMicrotask=="function"?queueMicrotask(e):setTimeout(e,0)}function C(e){const t=document.createElement(e.tag);if(e.class&&(t.className=e.class),e.attrs)for(const[r,o]of Object.entries(e.attrs))if(typeof o=="function"&&r.startsWith("on"))t.addEventListener(r.slice(2).toLowerCase(),o);else if(r==="style"&&typeof o=="object")Object.assign(t.style,o);else if(r==="dataset"&&typeof o=="object")for(const[i,a]of Object.entries(o))t.dataset[i]=String(a);else try{t.setAttribute(r,String(o))}catch{}if(e.style&&Object.assign(t.style,e.style),e.children)for(const r of e.children){const o=typeof r=="string"?document.createTextNode(r):C(r);t.appendChild(o)}return t}const q=s.enum(["top","right","bottom","left"]),Q=s.object({width:s.number(),height:s.number(),mode:s.enum(["static","animated","dynamic"]).optional()});s.object({rawHtml:s.string().optional(),needsCanvas:s.boolean().optional(),canvasOptions:Q.optional()});const Z=s.object({name:s.string(),version:s.string().optional()}),K=s.object({meta:Z.optional(),timestamp:s.number()}),S=s.object({id:q,payload:s.any().optional()}),ee=s.object({timestamp:s.number()}),re={"droid-ready":ee,"droid-mod-ready":K,"panel-open":S,"panel-close":S};class te{listeners=new Map;on(t,r){let o=this.listeners.get(t);o||(o=new Set,this.listeners.set(t,o)),o.add(r)}off(t,r){this.listeners.get(t)?.delete(r)}emit(t,r){const o=re[t];if(o)try{o.parse(r)}catch(i){console.error(`[DroidEventBus] Invalid payload for ${t}:`,i);return}window.dispatchEvent(new CustomEvent(t,{detail:r}));for(const i of this.listeners.get(t)??[])i(r)}wait(t){return new Promise(r=>{const o=i=>{this.off(t,o),r(i)};this.on(t,o)})}}const oe=new te,I="1.0.3";let L=!1;async function ne(e){let t=null;if(e?.workerRef)try{return e.workerRef.port.start(),t=c(e.workerRef.port),t}catch(r){console.warn("[DROID] ws-worker workerRef failed:",r)}if(e?.workerURL)try{const r=new SharedWorker(e.workerURL,{type:"module"});return r.port.start(),t=c(r.port),t}catch(r){console.warn("[DROID] ws-worker workerURL failed:",r)}try{const r=new SharedWorker(new URL("/assets/ws-worker.js",import.meta.url),{type:"module"});return r.port.start(),t=c(r.port),t}catch(r){console.warn("[DROID] ws-worker vite-style .ts import failed:",r)}try{const r=new SharedWorker(new URL("/assets/ws-worker.js",import.meta.url),{type:"module"});return r.port.start(),t=c(r.port),t}catch(r){console.warn("[DROID] ws-worker ./ws-worker.js fallback failed:",r)}try{const r=new SharedWorker(new URL("/ws-worker.js",import.meta.url),{type:"module"});return r.port.start(),t=c(r.port),t}catch(r){console.warn("[DROID] ws-worker absolute hardcoded fallback failed:",r)}throw console.error("[DROID] No WS Worker Comlink Initialized"),new Error("[DROID] Failed to initialize ws-worker")}const d=T("uiux-state",{panelManager:{top:{open:!1},right:{open:!1},bottom:{open:!1},left:{open:!1}},themeManager:{theme:"auto"},toastManager:{},scrollY:0},{encode:JSON.stringify,decode:JSON.parse});async function ae(e){let t=null;if(e?.workerRef)try{return t=c(e.workerRef),t}catch(r){console.warn("[DROID] Provided canvasWorkerRef failed:",r)}if(e?.workerURL)try{const r=new Worker(e.workerURL,{type:"module"});return t=c(r),t}catch(r){console.warn("[DROID] Provided canvasWorkerURL failed:",r)}try{const r=new Worker(new URL("/assets/canvas-worker.js",import.meta.url),{type:"module"});return t=c(r),t}catch(r){console.warn("[DROID] Vite-style canvas-worker.ts import failed:",r)}try{const r=new Worker(new URL("/assets/canvas-worker.js",import.meta.url),{type:"module"});return t=c(r),t}catch(r){console.warn("[DROID] canvas-worker.js (same dir) fallback failed:",r)}try{const r=new Worker(new URL("/canvas-worker.js",import.meta.url),{type:"module"});return t=c(r),t}catch(r){console.warn("[DROID] canvas-worker.js (absolute root) fallback failed:",r)}throw console.error("[DROID] No Canvas Comlink Initialized"),new Error("[DROID] Failed to initialize canvas worker")}const U={state:d,openPanel(e,t){const r={...d.get().panelManager};r[e]={open:!0,payload:t},d.setKey("panelManager",r)},closePanel(e){const t={...d.get().panelManager};t[e]={open:!1,payload:void 0},d.setKey("panelManager",t)},togglePanel(e,t){const r={...d.get().panelManager},o=r[e]?.open??!1;r[e]={open:!o,payload:o?void 0:t},d.setKey("panelManager",r)},setTheme(e){d.setKey("themeManager",{theme:e})},addToast(e,t){const r={...d.get().toastManager,[e]:t};d.setKey("toastManager",r)},removeToast(e){const t={...d.get().toastManager};delete t[e],d.setKey("toastManager",t)},async dispatchCanvasRequest(e,t,r="animated"){const o=t.transferControlToOffscreen();await window.kbve?.uiux?.worker?.bindCanvas(e,o,r)},closeAllPanels(){const e={...d.get().panelManager};console.log("error panel is closing");for(const t of Object.keys(e))e[t]={open:!1,payload:void 0};d.setKey("panelManager",e)},emitFromWorker(e){e.type==="injectVNode"&&e.vnode&&N(()=>{const t=document.getElementById("bento-grid-inject");if(!t){console.warn("[KBVE] No injection target found: #bento-grid-inject");return}const r=C(e.vnode);if(r.classList.add("animate-fade-in"),e.vnode.id){const o=document.getElementById(e.vnode.id);o&&o.remove()}t.appendChild(r)})}},p=T("i18n-cache",{},{encode:JSON.stringify,decode:JSON.parse}),m={store:p,api:null,ready:Promise.resolve(),get(e){return p.get()[e]??`[${e}]`},async getAsync(e){const t=p.get()[e];if(t!==void 0)return t;if(!this.api)return`[${e}]`;const r=await this.api.getTranslation(e);return r!==null?(p.setKey(e,r),r):`[${e}]`},set(e,t){p.setKey(e,t)},async hydrate(e,t){this.api=e;for(const r of t){const o=await e.getTranslation(r);o!==null&&p.setKey(r,o)}},async hydrateLocale(e="en"){if(!this.api)return;const r=(await this.api.getAllI18nKeys()).filter(i=>i.startsWith(`${e}:`)),o=await this.api.getTranslations(r);for(const[i,a]of Object.entries(o))console.log(`[i18n.setKey] ${i} = ${a}`),this.store.setKey(i,a)}};function A(){if(!navigator.serviceWorker?.controller)return;const e=new MessageChannel;navigator.serviceWorker.controller.postMessage(e.port2,[e.port2]),e.port1.start()}async function ie(e){let t=null;if(e?.workerRef)try{return e.workerRef.port.start(),t=c(e.workerRef.port),await k(t)}catch(r){console.warn("[DROID] db-worker workerRef failed:",r)}if(e?.workerURL)try{const r=new SharedWorker(e.workerURL,{type:"module"});return r.port.start(),t=c(r.port),await k(t)}catch(r){console.warn("[DROID] db-worker workerURL failed:",r)}try{const r=new SharedWorker(new URL("/assets/db-worker.js",import.meta.url),{type:"module"});return r.port.start(),t=c(r.port),await k(t)}catch(r){console.warn("[DROID] db-worker .ts vite-style import failed:",r)}try{const r=new SharedWorker(new URL("/assets/db-worker.js",import.meta.url),{type:"module"});return r.port.start(),t=c(r.port),await k(t)}catch(r){console.warn("[DROID] db-worker.js same-dir fallback failed:",r)}try{const r=new SharedWorker(new URL("/db-worker.js",import.meta.url),{type:"module"});return r.port.start(),t=c(r.port),await k(t)}catch(r){console.warn("[DROID] db-worker.js absolute hardcoded fallback failed:",r)}throw console.error("[DROID] No DB Worker Comlink Initialized"),new Error("[DROID] Failed to initialize db-worker")}async function k(e){return await e.getVersion()!==I&&await x(e,{version:I,i18nPath:"https://discord.sh/i18n/db.json",locale:"en",defaults:{welcome:"Welcome!",theme:"dark"}}),e}function se(e,t){const r=F(async o=>{N(()=>{const i=`ws:${Date.now()}`;t.storeWsMessage(i,o)})});e.onMessage(B(r,[0]))}async function me(e){if(console.log("[DROID]: Main<T>"),L||(L=!0,navigator.serviceWorker?.controller?A():navigator.serviceWorker?.addEventListener("controllerchange",A)),console.log("[DROID] Main<T> => Worker URLs",e?.workerURLs),!window.kbve?.api||!window.kbve?.i18n||!window.kbve?.uiux)try{console.log("[DROID] Main<T> => Worker => CanvasComlink");const r=await ae({workerRef:e?.workerRefs?.canvasWorker,workerURL:e?.workerURLs?.canvasWorker});console.log("[DROID] Main<T> => Worker => StorageComlink");const o=await ie({workerURL:typeof e?.workerURLs?.dbWorker=="string"?e.workerURLs.dbWorker:void 0,workerRef:e?.workerRefs?.dbWorker});console.log("[DROID] Main<T> => Worker => WsComlink");const i=await ne({workerRef:e?.workerRefs?.wsWorker,workerURL:e?.workerURLs?.wsWorker});console.log("[DROID] Main<T> => Worker => ModManager");const a=await z(f=>e?.workerURLs?.[f]??f),n=oe;for(const f of Object.values(a.registry))typeof f.instance.init=="function"&&await f.instance.init({emitFromWorker:U.emitFromWorker}),console.log("[Event] -> Fire Mod Ready"),n.emit("droid-mod-ready",{meta:f.meta,timestamp:Date.now()});se(i,o);const u=Y;m.api=o,m.ready=m.hydrateLocale("en"),window.kbve={...window.kbve||{},api:o,i18n:m,uiux:{...U,worker:r},ws:i,data:u,mod:a,events:n},await m.ready,window.kbve.events.emit("droid-ready",{timestamp:Date.now()}),document.addEventListener("astro:page-load",()=>{console.debug("[KBVE] Re-dispatched droid-ready after astro:page-load"),window.kbve?.events.emit("droid-ready",{timestamp:Date.now()})}),console.log("[KBVE] Global API ready")}catch(r){throw console.error("[DROID] Initialization error:",r),r}else console.log("[KBVE] Already initialized")}export{se as bridgeWsToDb,m as i18n,me as main,U as uiux};
