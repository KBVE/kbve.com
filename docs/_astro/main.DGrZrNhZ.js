import{w as E,p as U,t as C}from"./comlink.CPG-Ccvr.js";import{a as k}from"./@nanostores.fwZirWO6.js";import{B as W,t as S}from"./flatbuffers.BcE9oV44.js";import{z as s}from"./zod.D6aOmuMC.js";import"./react.BO4Kayu4.js";import"./@react-three.4bQWeJYP.js";import"./three.xRXBQ6Zu.js";import"./react-use-measure.yU5S79rD.js";import"./its-fine.B0m_k8NB.js";import"./react-reconciler.D42_nvds.js";import"./react-dom.Cq2Wkcjl.js";import"./@babel.CF3RwP-h.js";import"./three-stdlib.DSm8ebGF.js";import"./zustand.yH8b0vWy.js";import"./use-sync-external-store.ClVNGCf-.js";import"./nanostores.Bo9-_MAV.js";async function F(e,{version:t,i18nPath:o="https://discord.sh/i18n/db.json",locale:n="en",defaults:a={welcome:"Welcome to the app!"}}){console.log("[init-worker] Initializing database...");try{await e.loadI18nFromJSON(o),console.log(`[init-worker] i18n loaded from ${o}`),await e.dbSet("locale",n);for(const[r,i]of Object.entries(a))await e.dbSet(r,i);await e.setVersion(t),e.loadServersFromJSON(),console.log(`[init-worker] DB initialized to version ${t}`)}catch(r){console.error("[init-worker] Initialization failed:",r)}}let y=null;async function B(){if(y)return y;const e={};async function t(r){const i=new Worker(r,{type:"module"}),m=E(i),h=await m.getMeta?.()??{name:"unknown",version:"0.0.1"},v=`${h.name}@${h.version}`;console.log(`[mod-manager] ${v} is loaded.`);const b={id:v,worker:i,instance:m,meta:h,url:r};return e[v]=b,b}function o(r){e[r]&&(e[r].worker.terminate(),delete e[r])}function n(){return Object.values(e).map(r=>r.meta)}async function a(r){const i=e[r];if(!i)throw new Error(`Mod "${r}" not found`);return o(r),t(i.url)}return y={registry:e,load:t,unload:o,list:n,reload:a},y}var d=(e=>(e[e.PAYLOAD_UNKNOWN=0]="PAYLOAD_UNKNOWN",e[e.JSON=1]="JSON",e[e.FLEX=2]="FLEX",e[e.PROTOBUF=3]="PROTOBUF",e[e.FLATBUFFER=4]="FLATBUFFER",e))(d||{}),c=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.ADD=1]="ADD",e[e.READ=2]="READ",e[e.GET=4]="GET",e[e.SET=8]="SET",e[e.DEL=16]="DEL",e[e.STREAM=32]="STREAM",e[e.GROUP=64]="GROUP",e[e.LIST=128]="LIST",e[e.ACTION=256]="ACTION",e[e.MESSAGE=512]="MESSAGE",e[e.INFO=1024]="INFO",e[e.DEBUG=2048]="DEBUG",e[e.ERROR=4096]="ERROR",e[e.AUTH=8192]="AUTH",e[e.HEARTBEAT=16384]="HEARTBEAT",e[e.CONFIG_UPDATE=32768]="CONFIG_UPDATE",e[e.REDIS=65536]="REDIS",e[e.SUPABASE=131072]="SUPABASE",e[e.FILESYSTEM=262144]="FILESYSTEM",e[e.WEBSOCKET=524288]="WEBSOCKET",e[e.HTTP_API=1048576]="HTTP_API",e[e.LOCAL_CACHE=2097152]="LOCAL_CACHE",e[e.AI=4194304]="AI",e))(c||{});function w(){return new W}function P(e){const t=w();t.startMap();for(const[o,n]of Object.entries(e))t.addKey(o),t.add(n);return t.end(),t.finish()}function u(e,t,o,n,a=1){let r;if(o===d.FLEX)r=P(e);else if(o===d.JSON)r=new TextEncoder().encode(JSON.stringify(e));else throw new Error("Unsupported format for wrapEnvelope");const i=w();return i.startMap(),i.addKey("version"),i.add(a),i.addKey("kind"),i.add(t),i.addKey("format"),i.add(o),i.addKey("payload"),i.add(r),i.addKey("metadata"),i.add(n??new Uint8Array),i.end(),i.finish()}function g(e){const t=e instanceof Uint8Array?e:new Uint8Array(e),o=S(t.buffer).toObject();if(typeof o.version!="number"||typeof o.kind!="number"||typeof o.format!="number"||!o.payload)throw console.error("[unwrapEnvelope] Bad root:",o),new Error("[unwrapEnvelope] Invalid envelope structure");const n={version:o.version,kind:o.kind,format:o.format,payload:new Uint8Array(o.payload),metadata:o.metadata?new Uint8Array(o.metadata):void 0};let a;if(n.format===d.FLEX)a=S(n.payload.buffer).toObject();else if(n.format===d.JSON)a=JSON.parse(new TextDecoder().decode(n.payload));else throw new Error(`[unwrapEnvelope] Unsupported format: ${n.format}`);return{envelope:n,payload:a}}function N(e){return S(e.buffer).toObject()}function _(e){try{const t=e instanceof Uint8Array?e:new Uint8Array(e),o=N(t);console.log("[FlexObject]",JSON.stringify(o,null,2))}catch(t){console.error("[Flex Decode Error]",t)}}function I(e,t){return(e&t)===t}function x(e,t){return u({key:e,value:t},c.SET|c.REDIS,d.FLEX)}function $(e){return u({key:e},c.GET|c.REDIS,d.FLEX)}function J(e){return u({key:e},c.DEL|c.REDIS,d.FLEX)}function X(e){const t=g(e);if(!I(t.envelope.kind,c.REDIS))throw new Error("[Redis] Not a Redis envelope");return t}function G(e,t,o="*"){return u({stream:e,id:o,fields:t},c.ADD|c.STREAM|c.REDIS,d.FLEX)}function V(e,t,o){const n=w();n.startMap(),n.addKey("streams"),n.startVector();for(const{stream:i,id:m}of e)n.startMap(),n.addKey("stream"),n.add(i),n.addKey("id"),n.add(m),n.end();n.end(),t!==void 0&&(n.addKey("count"),n.add(t)),o!==void 0&&(n.addKey("block"),n.add(o)),n.end();const a=n.finish(),r=w();return r.startMap(),r.addKey("version"),r.add(1),r.addKey("kind"),r.add(c.READ|c.STREAM|c.REDIS),r.addKey("format"),r.add(d.FLEX),r.addKey("payload"),r.add(a),r.addKey("metadata"),r.add(new Uint8Array),r.end(),r.finish()}const z={wrapEnvelope:u,unwrapEnvelope:g,MessageKind:c,PayloadFormat:d,unwrapFlexToJson:N,inspectFlex:_,hasKind:I,redis:{wrapRedisSet:x,wrapRedisGet:$,wrapRedisDel:J,wrapRedisXAdd:G,wrapRedisXRead:V,parseRedisPayload:X}};function L(e){typeof queueMicrotask=="function"?queueMicrotask(e):setTimeout(e,0)}function j(e){const t=document.createElement(e.tag);if(e.class&&(t.className=e.class),e.attrs)for(const[o,n]of Object.entries(e.attrs))if(typeof n=="function"&&o.startsWith("on"))t.addEventListener(o.slice(2).toLowerCase(),n);else if(o==="style"&&typeof n=="object")Object.assign(t.style,n);else if(o==="dataset"&&typeof n=="object")for(const[a,r]of Object.entries(n))t.dataset[a]=String(r);else try{t.setAttribute(o,String(n))}catch{}if(e.style&&Object.assign(t.style,e.style),e.children)for(const o of e.children){const n=typeof o=="string"?document.createTextNode(o):j(o);t.appendChild(n)}return t}const H=s.enum(["top","right","bottom","left"]),Y=s.object({width:s.number(),height:s.number(),mode:s.enum(["static","animated","dynamic"]).optional()});s.object({rawHtml:s.string().optional(),needsCanvas:s.boolean().optional(),canvasOptions:Y.optional()});const q=s.object({name:s.string(),version:s.string().optional()}),Q=s.object({meta:q.optional(),timestamp:s.number()}),A=s.object({id:H,payload:s.any().optional()}),Z=s.object({timestamp:s.number()}),M={"droid-ready":Z,"droid-mod-ready":Q,"panel-open":A,"panel-close":A};class K{listeners=new Map;on(t,o){let n=this.listeners.get(t);n||(n=new Set,this.listeners.set(t,n)),n.add(o)}off(t,o){this.listeners.get(t)?.delete(o)}emit(t,o){const n=M[t];if(n)try{n.parse(o)}catch(a){console.error(`[DroidEventBus] Invalid payload for ${t}:`,a);return}window.dispatchEvent(new CustomEvent(t,{detail:o}));for(const a of this.listeners.get(t)??[])a(o)}wait(t){return new Promise(o=>{const n=a=>{this.off(t,n),o(a)};this.on(t,n)})}}const ee=new K,O="1.0.3";async function te(){const e=new SharedWorker(new URL("/_astro/ws-worker-FssAQgaD.js",import.meta.url),{type:"module"});return e.port.start(),E(e.port)}const l=k("uiux-state",{panelManager:{top:{open:!1},right:{open:!1},bottom:{open:!1},left:{open:!1}},themeManager:{theme:"auto"},toastManager:{},scrollY:0},{encode:JSON.stringify,decode:JSON.parse}),oe=E(new Worker(new URL("/_astro/canvas-worker-DbsoY2Xv.js",import.meta.url),{type:"module"})),D={state:l,worker:oe,openPanel(e,t){const o={...l.get().panelManager};o[e]={open:!0,payload:t},l.setKey("panelManager",o)},closePanel(e){const t={...l.get().panelManager};t[e]={open:!1,payload:void 0},l.setKey("panelManager",t)},togglePanel(e,t){const o={...l.get().panelManager},n=o[e]?.open??!1;o[e]={open:!n,payload:n?void 0:t},l.setKey("panelManager",o)},setTheme(e){l.setKey("themeManager",{theme:e})},addToast(e,t){const o={...l.get().toastManager,[e]:t};l.setKey("toastManager",o)},removeToast(e){const t={...l.get().toastManager};delete t[e],l.setKey("toastManager",t)},async dispatchCanvasRequest(e,t,o="animated"){const n=t.transferControlToOffscreen();await this.worker.bindCanvas(e,n,o)},closeAllPanels(){const e={...l.get().panelManager};console.log("error panel is closing");for(const t of Object.keys(e))e[t]={open:!1,payload:void 0};l.setKey("panelManager",e)},emitFromWorker(e){e.type==="injectVNode"&&e.vnode&&L(()=>{const t=document.getElementById("bento-grid-inject");if(!t){console.warn("[KBVE] No injection target found: #bento-grid-inject");return}const o=j(e.vnode);if(o.classList.add("animate-fade-in"),e.vnode.id){const n=document.getElementById(e.vnode.id);n&&n.remove()}t.appendChild(o)})}},p=k("i18n-cache",{},{encode:JSON.stringify,decode:JSON.parse}),f={store:p,api:null,ready:Promise.resolve(),get(e){return p.get()[e]??`[${e}]`},async getAsync(e){const t=p.get()[e];if(t!==void 0)return t;if(!this.api)return`[${e}]`;const o=await this.api.getTranslation(e);return o!==null?(p.setKey(e,o),o):`[${e}]`},set(e,t){p.setKey(e,t)},async hydrate(e,t){this.api=e;for(const o of t){const n=await e.getTranslation(o);n!==null&&p.setKey(o,n)}},async hydrateLocale(e="en"){if(!this.api)return;const o=(await this.api.getAllI18nKeys()).filter(a=>a.startsWith(`${e}:`)),n=await this.api.getTranslations(o);for(const[a,r]of Object.entries(n))console.log(`[i18n.setKey] ${a} = ${r}`),this.store.setKey(a,r)}};function R(){if(!navigator.serviceWorker?.controller)return;const e=new MessageChannel;navigator.serviceWorker.controller.postMessage(e.port2,[e.port2]),e.port1.start()}async function ne(){const e=new SharedWorker(new URL("/_astro/db-worker-CjXS52DQ.js",import.meta.url),{type:"module"});e.port.start();const t=E(e.port);return await t.getVersion()!==O&&await F(t,{version:O,i18nPath:"https://discord.sh/i18n/db.json",locale:"en",defaults:{welcome:"Welcome!",theme:"dark"}}),t}let T=!1;function re(e,t){const o=U(async n=>{L(()=>{const a=`ws:${Date.now()}`;t.storeWsMessage(a,n)})});e.onMessage(C(o,[0]))}async function be(){if(T||(T=!0,navigator.serviceWorker?.controller?R():navigator.serviceWorker?.addEventListener("controllerchange",R)),!window.kbve?.api||!window.kbve?.i18n||!window.kbve?.uiux){const t=await ne(),o=await te(),n=await B(),a=ee;for(const i of Object.values(n.registry))typeof i.instance.init=="function"&&await i.instance.init({emitFromWorker:D.emitFromWorker}),console.log("[Event] -> Fire Mod Ready"),a.emit("droid-mod-ready",{meta:i.meta,timestamp:Date.now()});re(o,t);const r=z;f.api=t,f.ready=f.hydrateLocale("en"),window.kbve={...window.kbve||{},api:t,i18n:f,uiux:D,ws:o,data:r,mod:n,events:a},await f.ready,window.kbve.events.emit("droid-ready",{timestamp:Date.now()}),document.addEventListener("astro:page-load",()=>{console.debug("[KBVE] Re-dispatched droid-ready after astro:page-load"),window.kbve?.events.emit("droid-ready",{timestamp:Date.now()})}),console.log("[KBVE] Global API ready")}else console.log("[KBVE] Already initialized")}export{re as bridgeWsToDb,f as i18n,be as main,D as uiux};
