import{w,p as U,t as L}from"./comlink.CPG-Ccvr.js";import{p as R}from"./@nanostores.BNqDkAkN.js";import{B as W,t as m}from"./flatbuffers.BcE9oV44.js";import"./nanostores.uU_Bu82q.js";async function F(e,{version:t,i18nPath:n="https://discord.sh/i18n/db.json",locale:o="en",defaults:a={welcome:"Welcome to the app!"}}){console.log("[init-worker] Initializing database...");try{await e.loadI18nFromJSON(n),console.log(`[init-worker] i18n loaded from ${n}`),await e.dbSet("locale",o);for(const[t,n]of Object.entries(a))await e.dbSet(t,n);await e.setVersion(t),e.loadServersFromJSON(),console.log(`[init-worker] DB initialized to version ${t}`)}catch(e){console.error("[init-worker] Initialization failed:",e)}}async function C(){const e={};async function t(t){const n=new Worker(t,{type:"module"}),o=w(n),a=await(o.getMeta?.())??{name:"unknown",version:"0.0.1"},r=`${a.name}@${a.version}`;"function"==typeof o.init&&await o.init(window.kbve);const s={id:r,worker:n,instance:o,meta:a,url:t};return e[r]=s,s}function n(t){const n=e[t];n&&(n.worker.terminate(),delete e[t])}return{registry:e,load:t,unload:n,list:function(){return Object.values(e).map((e=>e.meta))},reload:async function(o){const a=e[o];if(!a)throw new Error(`Mod "${o}" not found`);return n(o),t(a.url)}}}var l=(e=>(e[e.PAYLOAD_UNKNOWN=0]="PAYLOAD_UNKNOWN",e[e.JSON=1]="JSON",e[e.FLEX=2]="FLEX",e[e.PROTOBUF=3]="PROTOBUF",e[e.FLATBUFFER=4]="FLATBUFFER",e))(l||{}),s=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.ADD=1]="ADD",e[e.READ=2]="READ",e[e.GET=4]="GET",e[e.SET=8]="SET",e[e.DEL=16]="DEL",e[e.STREAM=32]="STREAM",e[e.GROUP=64]="GROUP",e[e.LIST=128]="LIST",e[e.ACTION=256]="ACTION",e[e.MESSAGE=512]="MESSAGE",e[e.INFO=1024]="INFO",e[e.DEBUG=2048]="DEBUG",e[e.ERROR=4096]="ERROR",e[e.AUTH=8192]="AUTH",e[e.HEARTBEAT=16384]="HEARTBEAT",e[e.CONFIG_UPDATE=32768]="CONFIG_UPDATE",e[e.REDIS=65536]="REDIS",e[e.SUPABASE=131072]="SUPABASE",e[e.FILESYSTEM=262144]="FILESYSTEM",e[e.WEBSOCKET=524288]="WEBSOCKET",e[e.HTTP_API=1048576]="HTTP_API",e[e.LOCAL_CACHE=2097152]="LOCAL_CACHE",e[e.AI=4194304]="AI",e))(s||{});function y(){return new W}function B(e){const t=y();t.startMap();for(const[n,o]of Object.entries(e))t.addKey(n),t.add(o);return t.end(),t.finish()}function u(e,t,n,o,a=1){let r;if(n===l.FLEX)r=B(e);else{if(n!==l.JSON)throw new Error("Unsupported format for wrapEnvelope");r=(new TextEncoder).encode(JSON.stringify(e))}const s=y();return s.startMap(),s.addKey("version"),s.add(a),s.addKey("kind"),s.add(t),s.addKey("format"),s.add(n),s.addKey("payload"),s.add(r),s.addKey("metadata"),s.add(o??new Uint8Array),s.end(),s.finish()}function k(e){const t=e instanceof Uint8Array?e:new Uint8Array(e),n=m(t.buffer).toObject();if("number"!=typeof n.version||"number"!=typeof n.kind||"number"!=typeof n.format||!n.payload)throw console.error("[unwrapEnvelope] Bad root:",n),new Error("[unwrapEnvelope] Invalid envelope structure");const o={version:n.version,kind:n.kind,format:n.format,payload:new Uint8Array(n.payload),metadata:n.metadata?new Uint8Array(n.metadata):void 0};let a;if(o.format===l.FLEX)a=m(o.payload.buffer).toObject();else{if(o.format!==l.JSON)throw new Error(`[unwrapEnvelope] Unsupported format: ${o.format}`);a=JSON.parse((new TextDecoder).decode(o.payload))}return{envelope:o,payload:a}}function b(e){return m(e.buffer).toObject()}function g(e){try{const t=b(e instanceof Uint8Array?e:new Uint8Array(e));console.log("[FlexObject]",JSON.stringify(t,null,2))}catch(e){console.error("[Flex Decode Error]",e)}}function D(e,t){return(e&t)===t}function j(e,t){return u({key:e,value:t},s.SET|s.REDIS,l.FLEX)}function P(e){return u({key:e},s.GET|s.REDIS,l.FLEX)}function J(e){return u({key:e},s.DEL|s.REDIS,l.FLEX)}function X(e){const t=k(e);if(!D(t.envelope.kind,s.REDIS))throw new Error("[Redis] Not a Redis envelope");return t}function x(e,t,n="*"){return u({stream:e,id:n,fields:t},s.ADD|s.STREAM|s.REDIS,l.FLEX)}function G(e,t,n){const o=y();o.startMap(),o.addKey("streams"),o.startVector();for(const{stream:t,id:n}of e)o.startMap(),o.addKey("stream"),o.add(t),o.addKey("id"),o.add(n),o.end();o.end(),void 0!==t&&(o.addKey("count"),o.add(t)),void 0!==n&&(o.addKey("block"),o.add(n)),o.end();const a=o.finish(),r=y();return r.startMap(),r.addKey("version"),r.add(1),r.addKey("kind"),r.add(s.READ|s.STREAM|s.REDIS),r.addKey("format"),r.add(l.FLEX),r.addKey("payload"),r.add(a),r.addKey("metadata"),r.add(new Uint8Array),r.end(),r.finish()}const _={wrapEnvelope:u,unwrapEnvelope:k,MessageKind:s,PayloadFormat:l,unwrapFlexToJson:b,inspectFlex:g,hasKind:D,redis:{wrapRedisSet:j,wrapRedisGet:P,wrapRedisDel:J,wrapRedisXAdd:x,wrapRedisXRead:G,parseRedisPayload:X}};function N(e){"function"==typeof queueMicrotask?queueMicrotask(e):setTimeout(e,0)}function I(e){const t=document.createElement(e.tag);if(e.class&&(t.className=e.class),e.attrs)for(const[n,o]of Object.entries(e.attrs))t.setAttribute(n,o);if(e.style&&Object.assign(t.style,e.style),e.children)for(const n of e.children)t.appendChild("string"==typeof n?document.createTextNode(n):I(n));return t}const S="1.0.3";async function $(){const e=new SharedWorker(new URL("/_astro/ws-worker-FssAQgaD.js",import.meta.url),{type:"module"});return e.port.start(),w(e.port)}const c=R("uiux-state",{panelManager:{top:{open:!1},right:{open:!1},bottom:{open:!1},left:{open:!1}},themeManager:{theme:"auto"},toastManager:{},scrollY:0},{encode:JSON.stringify,decode:JSON.parse}),z=w(new Worker(new URL("/_astro/canvas-worker-DbsoY2Xv.js",import.meta.url),{type:"module"})),h={state:c,worker:z,openPanel(e,t){const n={...c.get().panelManager};n[e]={open:!0,payload:t},c.setKey("panelManager",n)},closePanel(e){const t={...c.get().panelManager};t[e]={open:!1,payload:void 0},c.setKey("panelManager",t)},togglePanel(e,t){const n={...c.get().panelManager},o=n[e]?.open??!1;n[e]={open:!o,payload:o?void 0:t},c.setKey("panelManager",n)},setTheme(e){c.setKey("themeManager",{theme:e})},addToast(e,t){const n={...c.get().toastManager,[e]:t};c.setKey("toastManager",n)},removeToast(e){const t={...c.get().toastManager};delete t[e],c.setKey("toastManager",t)},async dispatchCanvasRequest(e,t,n="animated"){const o=t.transferControlToOffscreen();await this.worker.bindCanvas(e,o,n)},closeAllPanels(){const e={...c.get().panelManager};console.log("error panel is closing");for(const t of Object.keys(e))e[t]={open:!1,payload:void 0};c.setKey("panelManager",e)},emitFromWorker(e){"injectVNode"===e.type&&e.vnode&&N((()=>{const t=I(e.vnode);document.getElementById("bento-grid")?.appendChild(t)}))}},p=R("i18n-cache",{},{encode:JSON.stringify,decode:JSON.parse}),f={store:p,api:null,ready:Promise.resolve(),get:e=>p.get()[e]??`[${e}]`,async getAsync(e){const t=p.get()[e];if(void 0!==t)return t;if(!this.api)return`[${e}]`;const n=await this.api.getTranslation(e);return null!==n?(p.setKey(e,n),n):`[${e}]`},set(e,t){p.setKey(e,t)},async hydrate(e,t){this.api=e;for(const n of t){const t=await e.getTranslation(n);null!==t&&p.setKey(n,t)}},async hydrateLocale(e="en"){if(!this.api)return;const t=(await this.api.getAllI18nKeys()).filter((t=>t.startsWith(`${e}:`))),n=await this.api.getTranslations(t);for(const[e,t]of Object.entries(n))console.log(`[i18n.setKey] ${e} = ${t}`),this.store.setKey(e,t)}};function O(){if(!navigator.serviceWorker?.controller)return;const e=new MessageChannel;navigator.serviceWorker.controller.postMessage(e.port2,[e.port2]),e.port1.start()}async function V(){const e=new SharedWorker(new URL("/_astro/db-worker-CjXS52DQ.js",import.meta.url),{type:"module"});e.port.start();const t=w(e.port);return await t.getVersion()!==S&&await F(t,{version:S,i18nPath:"https://discord.sh/i18n/db.json",locale:"en",defaults:{welcome:"Welcome!",theme:"dark"}}),t}let T=!1;function H(e,t){const n=U((async e=>{N((()=>{const n=`ws:${Date.now()}`;t.storeWsMessage(n,e)}))}));e.onMessage(L(n,[0]))}async function Y(){if(T||(T=!0,navigator.serviceWorker?.controller?O():navigator.serviceWorker?.addEventListener("controllerchange",O)),window.kbve?.api&&window.kbve?.i18n&&window.kbve?.uiux)console.log("[KBVE] Already initialized");else{const e=await V(),t=await $(),n=await C();for(const e of Object.values(n.registry))"function"==typeof e.instance.init&&await e.instance.init({emitFromWorker:h.emitFromWorker});H(t,e);const o=_;f.api=e,f.ready=f.hydrateLocale("en"),window.kbve={...window.kbve||{},api:e,i18n:f,uiux:h,ws:t,data:o,mod:n},await f.ready,console.log("[KBVE] Global API ready")}}async function q(){return await Y(),{initialized:!0}}q().then((()=>{console.log("[KBVE] Droid initialized")}));