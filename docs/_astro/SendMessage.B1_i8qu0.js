import{r as a,R as F,j as e}from"./react.CvslfkeK.js";import{u as H}from"./react-hook-form.D5LhBzNo.js";import{t as $}from"./@hookform.DFFlZybA.js";import{g as P,d as L}from"./userstate.P8giVhEZ.js";import{supabase as A}from"./supabaseClient.xweZyGB4.js";import{z as i}from"./zod.D6aOmuMC.js";import{C as u,a as n}from"./lucide-react.Cq0BVVq0.js";import"./@react-three.B-wTPXHf.js";import"./@nanostores.vmeSb_hF.js";import"./nanostores.Bo9-_MAV.js";import"./@supabase.B1FuS6Fv.js";import"./Page.astro_astro_type_script_index_0_lang.DoJZq5Ub.js";import"./react-dom.DDrfKqI3.js";import"./svelte.BEh2_tzM.js";import"./esm-env.rsSWfq8L.js";async function O({receiver:s,title:x,description:c,message:m}){if(!s||!x||!m)return{success:!1,error:"Receiver, title, and message are required."};const{data:r,error:o}=await A.rpc("proxy_send_user_message",{p_receiver:s,p_title:x,p_description:c,p_message:m});return o?(console.error("[sendMessage] RPC Error:",o.message),{success:!1,error:o.message}):{success:!0,data:r}}const S=/<[^>]*>|(onerror|onload)\s*=|[\u0000-\u001F\u007F-\u009F\u200B-\u200F\u2028\u2029]/i,G=i.object({receiver:i.string().min(3,"Receiver is required"),title:i.string().min(1,"Title is required").max(100,"Title must be at most 100 characters").refine(s=>!S.test(s),{message:"Title contains disallowed content."}),description:i.string().max(300,"Description must be at most 300 characters").refine(s=>!S.test(s),{message:"Description contains disallowed content."}).optional().or(i.literal("")),message:i.string().min(1,"Message is required").max(5e3,"Message must be at most 5000 characters").refine(s=>!S.test(s),{message:"Message contains disallowed content."})}),ie=()=>{const{register:s,handleSubmit:x,setValue:c,watch:m,formState:{errors:r,isSubmitting:o,touchedFields:T},reset:_,trigger:p}=H({resolver:$(G)}),[g,z]=a.useState(null),[f,y]=a.useState(!1),[k,M]=a.useState(""),[N,b]=a.useState(!1),[E,j]=a.useState(null),[v,w]=a.useState(null),[I,C]=a.useState(!1),[R,B]=a.useState(null),l=m("receiver"),d=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(l);F.useEffect(()=>{d?(C(!0),w(null),B(null),P(l).then(t=>{w(t??null)}).catch(()=>B("Could not resolve username.")).finally(()=>C(!1))):w(null)},[l]);const V=async()=>{b(!0),j(null);try{const t=await L(k);t?(c("receiver",t,{shouldValidate:!0}),y(!1),M("")):j("No UUID found for that username.")}catch{j("Error looking up UUID.")}finally{b(!1)}},q=async t=>{z(null);const D=await O({...t,description:t.description??""});z(D),D.success&&_()},h={receiver:{tooltip:"Enter a valid UUID. If you have a username, use the lookup tool."},title:{tooltip:"1-100 characters. No HTML, scripts, or control characters."},description:{tooltip:"Up to 300 characters. No HTML, scripts, or control characters."},message:{tooltip:"1-5000 characters. No HTML, scripts, or control characters."}};F.useEffect(()=>{l&&!d&&l.length>3&&!f&&(b(!0),L(l).then(t=>{t&&c("receiver",t,{shouldValidate:!0})}).finally(()=>b(!1)))},[l,d,f,c]);const U=t=>!!(T[t]&&!r[t]);return e.jsxs("form",{onSubmit:x(q),className:"space-y-8 max-w-lg mx-auto p-10 bg-white/70 dark:bg-neutral-900/80 rounded-2xl shadow-2xl border border-neutral-200 dark:border-neutral-800 backdrop-blur-md",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsxs("span",{className:"font-bold text-xl text-cyan-800 dark:text-cyan-200 tracking-tight",children:["Send a Message ",e.jsx("span",{className:"text-base font-medium",children:"(1 credit)"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block font-semibold text-neutral-800 dark:text-neutral-100 flex items-center gap-2",children:["To (UUID Only)",e.jsxs("span",{className:"ml-1 cursor-pointer group relative",children:[d&&v?e.jsx(u,{size:16,className:"text-green-500 inline-block"}):e.jsx(n,{size:16,className:"text-yellow-500 inline-block"}),e.jsx("span",{className:"absolute left-1/2 -translate-x-1/2 mt-2 w-56 bg-neutral-800 text-neutral-100 text-xs rounded-lg px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 shadow-lg",children:h.receiver.tooltip})]})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{...s("receiver",{onBlur:t=>{p("receiver")}}),className:"w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800 px-4 py-2 text-base text-neutral-900 dark:text-neutral-100 placeholder:text-neutral-400 dark:placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition"}),e.jsx("button",{type:"button",className:"rounded-lg px-3 py-2 text-sm font-medium bg-cyan-100 dark:bg-cyan-900 text-cyan-800 dark:text-cyan-200 border border-cyan-200 dark:border-cyan-700 hover:bg-cyan-200 dark:hover:bg-cyan-800 transition",onClick:()=>y(t=>!t),children:"Find UUID"})]}),r.receiver&&e.jsxs("span",{className:"flex items-center gap-1 text-red-500 text-xs mt-1",children:[e.jsx(n,{size:14,className:"inline-block"}),r.receiver.message]}),f&&e.jsxs("div",{className:"mt-2 flex gap-2 items-center",children:[e.jsx("input",{type:"text",value:k,onChange:t=>M(t.target.value),placeholder:"Enter username",className:"rounded-lg border border-neutral-300 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800 px-3 py-1 text-sm text-neutral-900 dark:text-neutral-100 placeholder:text-neutral-400 dark:placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition w-40",disabled:N}),e.jsx("button",{type:"button",className:"rounded-lg px-3 py-1 text-sm font-medium bg-cyan-200 dark:bg-cyan-800 text-cyan-900 dark:text-cyan-100 border border-cyan-300 dark:border-cyan-600 hover:bg-cyan-300 dark:hover:bg-cyan-700 transition",onClick:V,disabled:N||!k,children:N?"Searching...":"Lookup"}),e.jsx("button",{type:"button",className:"rounded-lg px-3 py-1 text-sm font-medium bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-200 border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition",onClick:()=>y(!1),children:"Cancel"}),E&&e.jsx("span",{className:"text-red-500 text-xs ml-2",children:E})]}),d&&e.jsxs("div",{className:"mt-1 text-xs text-cyan-700 dark:text-cyan-200 font-medium flex items-center gap-1",children:[e.jsx(u,{size:14,className:"inline-block text-green-500"}),I?"Resolving username...":v?`Receiver: ${v}`:R?e.jsx("span",{className:"text-red-500",children:R}):null]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block font-semibold text-neutral-800 dark:text-neutral-100 flex items-center gap-2",children:["Title",e.jsxs("span",{className:"ml-1 cursor-pointer group relative",children:[r.title?e.jsx(n,{size:16,className:"text-yellow-500 inline-block"}):U("title")?e.jsx(u,{size:16,className:"text-green-500 inline-block"}):null,e.jsx("span",{className:"absolute left-1/2 -translate-x-1/2 mt-2 w-56 bg-neutral-800 text-neutral-100 text-xs rounded-lg px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 shadow-lg",children:h.title.tooltip})]})]}),e.jsx("input",{...s("title",{onBlur:t=>{p("title")}}),className:"w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800 px-4 py-2 text-base text-neutral-900 dark:text-neutral-100 placeholder:text-neutral-400 dark:placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition"}),r.title&&e.jsxs("span",{className:"flex items-center gap-1 text-red-500 text-xs mt-1",children:[e.jsx(n,{size:14,className:"inline-block"}),r.title.message]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block font-semibold text-neutral-800 dark:text-neutral-100 flex items-center gap-2",children:["Description (optional)",e.jsxs("span",{className:"ml-1 cursor-pointer group relative",children:[r.description?e.jsx(n,{size:16,className:"text-yellow-500 inline-block"}):U("description")?e.jsx(u,{size:16,className:"text-green-500 inline-block"}):null,e.jsx("span",{className:"absolute left-1/2 -translate-x-1/2 mt-2 w-56 bg-neutral-800 text-neutral-100 text-xs rounded-lg px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 shadow-lg",children:h.description.tooltip})]})]}),e.jsx("input",{...s("description",{onBlur:t=>{p("description")}}),className:"w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800 px-4 py-2 text-base text-neutral-900 dark:text-neutral-100 placeholder:text-neutral-400 dark:placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition"}),r.description&&e.jsxs("span",{className:"flex items-center gap-1 text-red-500 text-xs mt-1",children:[e.jsx(n,{size:14,className:"inline-block"}),r.description.message]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block font-semibold text-neutral-800 dark:text-neutral-100 flex items-center gap-2",children:["Message",e.jsxs("span",{className:"ml-1 cursor-pointer group relative",children:[r.message?e.jsx(n,{size:16,className:"text-yellow-500 inline-block"}):U("message")?e.jsx(u,{size:16,className:"text-green-500 inline-block"}):null,e.jsx("span",{className:"absolute left-1/2 -translate-x-1/2 mt-2 w-56 bg-neutral-800 text-neutral-100 text-xs rounded-lg px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 shadow-lg",children:h.message.tooltip})]})]}),e.jsx("textarea",{...s("message",{onBlur:t=>{p("message")}}),className:"w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800 px-4 py-2 text-base text-neutral-900 dark:text-neutral-100 placeholder:text-neutral-400 dark:placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition min-h-[120px]"}),r.message&&e.jsxs("span",{className:"flex items-center gap-1 text-red-500 text-xs mt-1",children:[e.jsx(n,{size:14,className:"inline-block"}),r.message.message]})]}),e.jsx("button",{type:"submit",className:"w-full rounded-lg py-3 text-base font-semibold bg-cyan-600 dark:bg-cyan-700 hover:bg-cyan-700 dark:hover:bg-cyan-600 border border-cyan-700 dark:border-cyan-600 text-white dark:text-neutral-100 shadow-lg transition",disabled:o,children:o?"Sending...":"Send Message (1 credit)"}),g&&e.jsx("div",{className:g.success?"text-green-600 mt-4 text-center font-medium":"text-red-600 mt-4 text-center font-medium",children:g.success?"Message sent successfully!":`Error: ${g.error}`})]})};export{ie as SendMessage};
