import{w as E,p as U,t as g}from"./comlink.CPG-Ccvr.js";import{a as R}from"./@nanostores.CPtJN9Fh.js";import{B as j,t as S}from"./flatbuffers.BcE9oV44.js";import"./nanostores.qAfxXu-z.js";import"./react.Yb-Yb6pG.js";import"./@react-three.HOJu3ppJ.js";async function W(e,{version:t,i18nPath:n="https://discord.sh/i18n/db.json",locale:o="en",defaults:a={welcome:"Welcome to the app!"}}){console.log("[init-worker] Initializing database...");try{await e.loadI18nFromJSON(n),console.log(`[init-worker] i18n loaded from ${n}`),await e.dbSet("locale",o);for(const[t,n]of Object.entries(a))await e.dbSet(t,n);await e.setVersion(t),e.loadServersFromJSON(),console.log(`[init-worker] DB initialized to version ${t}`)}catch(e){console.error("[init-worker] Initialization failed:",e)}}let y=null;async function F(){if(y)return y;const e={};async function t(t){const n=new Worker(t,{type:"module"}),o=E(n),a=await(o.getMeta?.())??{name:"unknown",version:"0.0.1"},r=`${a.name}@${a.version}`;console.log(`[mod-manager] ${r} is loaded.`);const s={id:r,worker:n,instance:o,meta:a,url:t};return e[r]=s,s}function n(t){e[t]&&(e[t].worker.terminate(),delete e[t])}return y={registry:e,load:t,unload:n,list:function(){return Object.values(e).map((e=>e.meta))},reload:async function(o){const a=e[o];if(!a)throw new Error(`Mod "${o}" not found`);return n(o),t(a.url)}},y}var l=(e=>(e[e.PAYLOAD_UNKNOWN=0]="PAYLOAD_UNKNOWN",e[e.JSON=1]="JSON",e[e.FLEX=2]="FLEX",e[e.PROTOBUF=3]="PROTOBUF",e[e.FLATBUFFER=4]="FLATBUFFER",e))(l||{}),s=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.ADD=1]="ADD",e[e.READ=2]="READ",e[e.GET=4]="GET",e[e.SET=8]="SET",e[e.DEL=16]="DEL",e[e.STREAM=32]="STREAM",e[e.GROUP=64]="GROUP",e[e.LIST=128]="LIST",e[e.ACTION=256]="ACTION",e[e.MESSAGE=512]="MESSAGE",e[e.INFO=1024]="INFO",e[e.DEBUG=2048]="DEBUG",e[e.ERROR=4096]="ERROR",e[e.AUTH=8192]="AUTH",e[e.HEARTBEAT=16384]="HEARTBEAT",e[e.CONFIG_UPDATE=32768]="CONFIG_UPDATE",e[e.REDIS=65536]="REDIS",e[e.SUPABASE=131072]="SUPABASE",e[e.FILESYSTEM=262144]="FILESYSTEM",e[e.WEBSOCKET=524288]="WEBSOCKET",e[e.HTTP_API=1048576]="HTTP_API",e[e.LOCAL_CACHE=2097152]="LOCAL_CACHE",e[e.AI=4194304]="AI",e))(s||{});function w(){return new j}function C(e){const t=w();t.startMap();for(const[n,o]of Object.entries(e))t.addKey(n),t.add(o);return t.end(),t.finish()}function p(e,t,n,o,a=1){let r;if(n===l.FLEX)r=C(e);else{if(n!==l.JSON)throw new Error("Unsupported format for wrapEnvelope");r=(new TextEncoder).encode(JSON.stringify(e))}const s=w();return s.startMap(),s.addKey("version"),s.add(a),s.addKey("kind"),s.add(t),s.addKey("format"),s.add(n),s.addKey("payload"),s.add(r),s.addKey("metadata"),s.add(o??new Uint8Array),s.end(),s.finish()}function k(e){const t=e instanceof Uint8Array?e:new Uint8Array(e),n=S(t.buffer).toObject();if("number"!=typeof n.version||"number"!=typeof n.kind||"number"!=typeof n.format||!n.payload)throw console.error("[unwrapEnvelope] Bad root:",n),new Error("[unwrapEnvelope] Invalid envelope structure");const o={version:n.version,kind:n.kind,format:n.format,payload:new Uint8Array(n.payload),metadata:n.metadata?new Uint8Array(n.metadata):void 0};let a;if(o.format===l.FLEX)a=S(o.payload.buffer).toObject();else{if(o.format!==l.JSON)throw new Error(`[unwrapEnvelope] Unsupported format: ${o.format}`);a=JSON.parse((new TextDecoder).decode(o.payload))}return{envelope:o,payload:a}}function D(e){return S(e.buffer).toObject()}function B(e){try{const t=D(e instanceof Uint8Array?e:new Uint8Array(e));console.log("[FlexObject]",JSON.stringify(t,null,2))}catch(e){console.error("[Flex Decode Error]",e)}}function N(e,t){return(e&t)===t}function P(e,t){return p({key:e,value:t},s.SET|s.REDIS,l.FLEX)}function x(e){return p({key:e},s.GET|s.REDIS,l.FLEX)}function J(e){return p({key:e},s.DEL|s.REDIS,l.FLEX)}function X(e){const t=k(e);if(!N(t.envelope.kind,s.REDIS))throw new Error("[Redis] Not a Redis envelope");return t}function _(e,t,n="*"){return p({stream:e,id:n,fields:t},s.ADD|s.STREAM|s.REDIS,l.FLEX)}function $(e,t,n){const o=w();o.startMap(),o.addKey("streams"),o.startVector();for(const{stream:t,id:n}of e)o.startMap(),o.addKey("stream"),o.add(t),o.addKey("id"),o.add(n),o.end();o.end(),void 0!==t&&(o.addKey("count"),o.add(t)),void 0!==n&&(o.addKey("block"),o.add(n)),o.end();const a=o.finish(),r=w();return r.startMap(),r.addKey("version"),r.add(1),r.addKey("kind"),r.add(s.READ|s.STREAM|s.REDIS),r.addKey("format"),r.add(l.FLEX),r.addKey("payload"),r.add(a),r.addKey("metadata"),r.add(new Uint8Array),r.end(),r.finish()}const G={wrapEnvelope:p,unwrapEnvelope:k,MessageKind:s,PayloadFormat:l,unwrapFlexToJson:D,inspectFlex:B,hasKind:N,redis:{wrapRedisSet:P,wrapRedisGet:x,wrapRedisDel:J,wrapRedisXAdd:_,wrapRedisXRead:$,parseRedisPayload:X}};function I(e){"function"==typeof queueMicrotask?queueMicrotask(e):setTimeout(e,0)}function L(e){const t=document.createElement(e.tag);if(e.class&&(t.className=e.class),e.attrs)for(const[n,o]of Object.entries(e.attrs))if("function"==typeof o&&n.startsWith("on"))t.addEventListener(n.slice(2).toLowerCase(),o);else if("style"===n&&"object"==typeof o)Object.assign(t.style,o);else if("dataset"===n&&"object"==typeof o)for(const[e,n]of Object.entries(o))t.dataset[e]=String(n);else try{t.setAttribute(n,String(o))}catch{}if(e.style&&Object.assign(t.style,e.style),e.children)for(const n of e.children){const e="string"==typeof n?document.createTextNode(n):L(n);t.appendChild(e)}return t}const h="1.0.3";async function V(){const e=new SharedWorker(new URL("/_astro/ws-worker-FssAQgaD.js",import.meta.url),{type:"module"});return e.port.start(),E(e.port)}const c=R("uiux-state",{panelManager:{top:{open:!1},right:{open:!1},bottom:{open:!1},left:{open:!1}},themeManager:{theme:"auto"},toastManager:{},scrollY:0},{encode:JSON.stringify,decode:JSON.parse}),z=E(new Worker(new URL("/_astro/canvas-worker-DbsoY2Xv.js",import.meta.url),{type:"module"})),O={state:c,worker:z,openPanel(e,t){const n={...c.get().panelManager};n[e]={open:!0,payload:t},c.setKey("panelManager",n)},closePanel(e){const t={...c.get().panelManager};t[e]={open:!1,payload:void 0},c.setKey("panelManager",t)},togglePanel(e,t){const n={...c.get().panelManager},o=n[e]?.open??!1;n[e]={open:!o,payload:o?void 0:t},c.setKey("panelManager",n)},setTheme(e){c.setKey("themeManager",{theme:e})},addToast(e,t){const n={...c.get().toastManager,[e]:t};c.setKey("toastManager",n)},removeToast(e){const t={...c.get().toastManager};delete t[e],c.setKey("toastManager",t)},async dispatchCanvasRequest(e,t,n="animated"){const o=t.transferControlToOffscreen();await this.worker.bindCanvas(e,o,n)},closeAllPanels(){const e={...c.get().panelManager};console.log("error panel is closing");for(const t of Object.keys(e))e[t]={open:!1,payload:void 0};c.setKey("panelManager",e)},emitFromWorker(e){"injectVNode"===e.type&&e.vnode&&I((()=>{const t=document.getElementById("bento-grid-inject");if(!t)return void console.warn("[KBVE] No injection target found: #bento-grid-inject");const n=L(e.vnode);if(n.classList.add("animate-fade-in"),e.vnode.id){const t=document.getElementById(e.vnode.id);t&&t.remove()}t.appendChild(n)}))}},d=R("i18n-cache",{},{encode:JSON.stringify,decode:JSON.parse}),f={store:d,api:null,ready:Promise.resolve(),get:e=>d.get()[e]??`[${e}]`,async getAsync(e){const t=d.get()[e];if(void 0!==t)return t;if(!this.api)return`[${e}]`;const n=await this.api.getTranslation(e);return null!==n?(d.setKey(e,n),n):`[${e}]`},set(e,t){d.setKey(e,t)},async hydrate(e,t){this.api=e;for(const n of t){const t=await e.getTranslation(n);null!==t&&d.setKey(n,t)}},async hydrateLocale(e="en"){if(!this.api)return;const t=(await this.api.getAllI18nKeys()).filter((t=>t.startsWith(`${e}:`))),n=await this.api.getTranslations(t);for(const[e,t]of Object.entries(n))console.log(`[i18n.setKey] ${e} = ${t}`),this.store.setKey(e,t)}};function T(){if(!navigator.serviceWorker?.controller)return;const e=new MessageChannel;navigator.serviceWorker.controller.postMessage(e.port2,[e.port2]),e.port1.start()}async function H(){const e=new SharedWorker(new URL("/_astro/db-worker-CjXS52DQ.js",import.meta.url),{type:"module"});e.port.start();const t=E(e.port);return await t.getVersion()!==h&&await W(t,{version:h,i18nPath:"https://discord.sh/i18n/db.json",locale:"en",defaults:{welcome:"Welcome!",theme:"dark"}}),t}let b=!1;function Y(e,t){const n=U((async e=>{I((()=>{const n=`ws:${Date.now()}`;t.storeWsMessage(n,e)}))}));e.onMessage(g(n,[0]))}async function te(){if(b||(b=!0,navigator.serviceWorker?.controller?T():navigator.serviceWorker?.addEventListener("controllerchange",T)),window.kbve?.api&&window.kbve?.i18n&&window.kbve?.uiux)console.log("[KBVE] Already initialized");else{const e=await H(),t=await V(),n=await F();for(const e of Object.values(n.registry))"function"==typeof e.instance.init&&await e.instance.init({emitFromWorker:O.emitFromWorker});Y(t,e);const o=G;f.api=e,f.ready=f.hydrateLocale("en"),window.kbve={...window.kbve||{},api:e,i18n:f,uiux:O,ws:t,data:o,mod:n},await f.ready,console.log("[KBVE] Global API ready")}}export{Y as bridgeWsToDb,f as i18n,te as main,O as uiux};