let u=[],a=(e,t)=>{let l=[],n={get:()=>(n.lc||n.listen((()=>{}))(),n.value),l:0,lc:0,listen:(e,t)=>(n.lc=l.push(e,t||n.l)/2,()=>{let t=l.indexOf(e);~t&&(l.splice(t,2),--n.lc||n.off())}),notify(e){let t=!u.length;for(let t=0;t<l.length;t+=2)u.push(l[t],l[t+1],n.value,e);if(t){for(let e=0;e<u.length;e+=4){let t;for(let l=e+1;!t&&(l+=4)<u.length;)u[l]<u[e+1]&&(t=u.push(u[e],u[e+1],u[e+2],u[e+3]));t||u[e](u[e+2],u[e+3])}u.length=0}},off(){},set(e){n.value!==e&&(n.value=e,n.notify())},subscribe(e,t){let l=n.listen(e,t);return e(n.value),l},value:e};return n},r=(e,t,l,u)=>(e.events=e.events||{},e.events[l+10]||(e.events[l+10]=u((t=>{e.events[l].reduceRight(((e,t)=>(t(e),e)),{shared:{},...t})}))),e.events[l]=e.events[l]||[],e.events[l].push(t),()=>{let u=e.events[l],n=u.indexOf(t);u.splice(n,1),u.length||(delete e.events[l],e.events[l+10](),delete e.events[l+10])}),N=1e3,U=(e,t)=>r(e,(l=>{let u=t(l);u&&e.events[6].push(u)}),5,(t=>{let l=e.listen;e.listen=(...u)=>(!e.lc&&!e.active&&(e.active=!0,t()),l(...u));let u=e.off;return e.events[6]=[],e.off=()=>{u(),setTimeout((()=>{if(e.active&&!e.lc){e.active=!1;for(let t of e.events[6])t();e.events[6]=[]}}),N)},()=>{e.listen=l,e.off=u}})),O=(e={})=>{let t=a(e);return t.setKey=function(e,l){typeof l>"u"?e in t.value&&(t.value={...t.value},delete t.value[e],t.notify(e)):t.value[e]!==l&&(t.value={...t.value,[e]:l},t.notify(e))},t};export{O as m,U as o};