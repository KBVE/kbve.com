let d=0,p=[];function c(){return d+=1,()=>{if(d-=1,d===0){let e=p;p=[];for(let f of e)f()}}}function m(e){let f=c();return e().finally(f)}let s=[],g=(e,f)=>{let t=[],n={get(){return n.lc||n.listen(()=>{})(),n.value},l:0,lc:0,listen(i,u){return n.lc=t.push(i,u||n.l)/2,()=>{let l=t.indexOf(i);~l&&(t.splice(l,2),--n.lc||n.off())}},notify(i){let u=!s.length;for(let l=0;l<t.length;l+=2)s.push(t[l],t[l+1],n.value,i);if(u){for(let l=0;l<s.length;l+=4){let v;for(let h=l+1;!v&&(h+=4)<s.length;)s[h]<s[l+1]&&(v=s.push(s[l],s[l+1],s[l+2],s[l+3]));v||s[l](s[l+2],s[l+3])}s.length=0}},off(){},set(i){n.value!==i&&(n.value=i,n.notify())},subscribe(i,u){let l=n.listen(i,u);return i(n.value),l},value:e};return n};const o=5,a=6,r=10;let T=(e,f,t,n)=>(e.events=e.events||{},e.events[t+r]||(e.events[t+r]=n(i=>{e.events[t].reduceRight((u,l)=>(l(u),u),{shared:{},...i})})),e.events[t]=e.events[t]||[],e.events[t].push(f),()=>{let i=e.events[t],u=i.indexOf(f);i.splice(u,1),i.length||(delete e.events[t],e.events[t+r](),delete e.events[t+r])}),O=1e3,N=(e,f)=>T(e,n=>{let i=f(n);i&&e.events[a].push(i)},o,n=>{let i=e.listen;e.listen=(...l)=>(!e.lc&&!e.active&&(e.active=!0,n()),i(...l));let u=e.off;return e.events[a]=[],e.off=()=>{u(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let l of e.events[a])l();e.events[a]=[]}},O)},()=>{e.listen=i,e.off=u}}),U=(e={})=>{let f=g(e);return f.setKey=function(t,n){typeof n>"u"?t in f.value&&(f.value={...f.value},delete f.value[t],f.notify(t)):f.value[t]!==n&&(f.value={...f.value,[t]:n},f.notify(t))},f};export{g as a,U as m,N as o,m as t};
